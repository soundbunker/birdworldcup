<!doctype html>
<html lang="ko">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>새소리 이상형월드컵 (12개)</title>
  <style>
    :root {
      --bg: #0b0f14;
      --card: #121826;
      --muted: #94a3b8;
      --text: #e5e7eb;
      --accent: #60a5fa;
      --accent-2: #34d399;
      --danger: #f87171;
      --ring: rgba(96,165,250,.45);
      --radius: 16px;
      
      /* 라운드별 배경색 */
      --round1-bg: rgba(59, 130, 246, 0.15);
      --round2-bg: rgba(239, 68, 68, 0.15);
      --round3-bg: rgba(34, 197, 94, 0.15);
      --round4-bg: rgba(168, 85, 247, 0.15);
      --final-bg: rgba(251, 191, 36, 0.15);
    }
    * { box-sizing: border-box; }
    html, body { height: 100%; }
    body {
      margin: 0; font-family: ui-sans-serif, system-ui, -apple-system, "Segoe UI", Roboto, "Helvetica Neue", Arial, "Apple SD Gothic Neo", "Noto Sans KR", "Malgun Gothic", sans-serif;
      background: radial-gradient(1200px 800px at 20% -20%, #1f2937 0%, transparent 60%),
                  radial-gradient(1000px 700px at 120% 0%, #0f172a 0%, transparent 65%),
                  var(--bg);
      color: var(--text);
      display: flex; align-items: center; justify-content: center;
      padding: 24px;
    }
    .app { width: 100%; max-width: 1100px; }
    header { display:flex; align-items:center; justify-content:space-between; gap: 12px; margin-bottom: 14px; }
    h1 { margin: 0; font-size: clamp(18px, 2.5vw, 28px); font-weight: 800; letter-spacing: 0.2px; }
    .toolbar { display:flex; flex-wrap: wrap; gap: 8px; }
    button, .btn {
      background: linear-gradient(180deg, #1f2937, #0b1220);
      color: var(--text); border: 1px solid #1f2a44; padding: 10px 14px; border-radius: 12px;
      cursor: pointer; font-weight: 600; transition: .2s ease; font-size: 14px;
    }
    button:hover { border-color: var(--accent); box-shadow: 0 0 0 4px var(--ring); }
    .btn-secondary { background: #111827; }
    .btn-danger { border-color: #402227; background: #1a0f12; color: #fecaca; }

    .stage { background: rgba(17,24,39,.6); border: 1px solid #1f2a44; border-radius: var(--radius); padding: 18px; transition: background 0.5s ease; }
    .stage.round-1 { background: var(--round1-bg); border-color: rgba(59, 130, 246, 0.3); }
    .stage.round-2 { background: var(--round2-bg); border-color: rgba(239, 68, 68, 0.3); }
    .stage.round-3 { background: var(--round3-bg); border-color: rgba(34, 197, 94, 0.3); }
    .stage.round-4 { background: var(--round4-bg); border-color: rgba(168, 85, 247, 0.3); }
    .stage.final { background: var(--final-bg); border-color: rgba(251, 191, 36, 0.3); }
    .status { display:flex; align-items:center; justify-content:space-between; gap: 8px; margin-bottom: 14px; font-size: 14px; color: var(--muted); }
    .status b { color: var(--text); }
    .round-title { font-size: clamp(24px, 4vw, 36px); font-weight: 900; text-align: center; margin-bottom: 20px; color: var(--text); text-shadow: 0 2px 4px rgba(0,0,0,0.5); }

    .versus { display:grid; grid-template-columns: 1fr auto 1fr; gap: 12px; align-items: stretch; }
    .card { background: var(--card); border: 1px solid #1f2a44; border-radius: var(--radius); padding: 16px; display:flex; flex-direction:column; gap: 12px; position: relative; min-height: 280px; }
    .bird-image { width: 100%; height: 150px; object-fit: cover; border-radius: 8px; background: #1f2937; border: 1px solid #374151; }
    .image-placeholder { width: 100%; height: 150px; background: linear-gradient(135deg, #1f2937, #374151); border-radius: 8px; display: flex; align-items: center; justify-content: center; color: var(--muted); font-size: 24px; border: 1px solid #374151; }
    .card.winner { outline: 3px solid var(--accent-2); }
    .label { font-weight: 800; font-size: clamp(16px, 2vw, 20px); line-height: 1.2; }
    .sub { color: var(--muted); font-size: 12px; }

    .audio { display:flex; align-items:center; gap: 10px; }
    .audio button { padding: 8px 12px; }
    .progress { height: 6px; background:#111827; border-radius: 999px; overflow: hidden; border: 1px solid #1f2a44; }
    .bar { height: 100%; width: 0%; background: linear-gradient(90deg, var(--accent), #22d3ee); }

    .vs { display:flex; align-items:center; justify-content:center; font-weight:900; font-size: 28px; color:#cbd5e1; }

    .actions { display:grid; grid-template-columns: 1fr 1fr; gap: 10px; margin-top: 4px; }
    .actions button { font-size: 16px; padding: 12px; }
    .next { width: 100%; margin-top: 12px; padding: 12px; font-size: 16px; }

    .bracket { margin-top: 16px; display:flex; gap: 6px; flex-wrap: wrap; }
    .chip { background:#111827; border:1px solid #1f2a44; border-radius: 999px; padding: 6px 10px; font-size: 12px; color:#cbd5e1; }

    .footer { margin-top: 12px; color: var(--muted); font-size: 12px; display:flex; justify-content: space-between; gap: 8px; }
    .footer code { background:#0b1220; padding:2px 6px; border-radius:6px; border:1px solid #1f2a44; }

    .hidden { display: none; }
    
    /* 올림픽 단상 스타일 */
    .podium { display: none; flex-direction: column; align-items: center; gap: 20px; padding: 30px; }
    .podium.show { display: flex; }
    .podium-title { font-size: clamp(28px, 5vw, 42px); font-weight: 900; color: var(--text); text-shadow: 0 2px 8px rgba(0,0,0,0.7); margin-bottom: 20px; }
    .podium-container { display: flex; align-items: end; gap: 15px; justify-content: center; flex-wrap: wrap; }
    .podium-place { display: flex; flex-direction: column; align-items: center; position: relative; }
    .podium-image { width: 120px; height: 120px; border-radius: 50%; object-fit: cover; border: 4px solid; margin-bottom: 10px; }
    .podium-base { display: flex; flex-direction: column; align-items: center; justify-content: center; border-radius: 8px; padding: 15px 20px; position: relative; }
    .podium-rank { font-size: 24px; font-weight: 900; margin-bottom: 5px; }
    .podium-name { font-size: 16px; font-weight: 600; text-align: center; }
    
    .first-place .podium-image { border-color: #ffd700; box-shadow: 0 0 20px rgba(255, 215, 0, 0.5); }
    .first-place .podium-base { background: linear-gradient(145deg, #ffd700, #ffed4a); color: #1a1a1a; height: 100px; }
    .first-place .podium-rank::before { content: '🥇 '; }
    
    .second-place .podium-image { border-color: #c0c0c0; box-shadow: 0 0 15px rgba(192, 192, 192, 0.5); }
    .second-place .podium-base { background: linear-gradient(145deg, #c0c0c0, #e5e5e5); color: #1a1a1a; height: 80px; }
    .second-place .podium-rank::before { content: '🥈 '; }
    
    .third-place .podium-image { border-color: #cd7f32; box-shadow: 0 0 15px rgba(205, 127, 50, 0.5); }
    .third-place .podium-base { background: linear-gradient(145deg, #cd7f32, #daa520); color: #1a1a1a; height: 60px; }
    .third-place .podium-rank::before { content: '🥉 '; }
    
    @media (max-width: 800px) {
      .versus { grid-template-columns: 1fr; }
      .vs { order: -1; }
      .podium-container { flex-direction: column; align-items: center; }
      .podium-place { margin-bottom: 15px; }
    }
  </style>
</head>
<body>
  <div class="app">
    <header>
      <h1>🕊️ 새소리 이상형월드컵</h1>
      <div class="toolbar">
        <label class="btn btn-secondary" title="오디오 파일 12개를 선택해 바로 시작">
          파일 불러오기<input id="fileInput" type="file" accept="audio/*" multiple class="hidden" />
        </label>
        <button id="shuffleBtn" class="btn btn-secondary" title="현재 라운드 참가자 섞기">셔플</button>
        <button id="restartBtn" class="btn btn-secondary" title="처음부터 다시">처음부터</button>
        <button id="exportBtn" class="btn" title="결과를 JSON으로 저장">결과 내보내기</button>
      </div>
    </header>

    <div class="stage">
      <div class="round-title" id="roundTitle">-</div>
      <div class="status">
        <div>매치 <b id="matchIndex">0</b>/<b id="matchTotal">0</b></div>
        <div>남은 참가자: <b id="remaining">0</b></div>
      </div>

      <div class="versus">
        <div class="card" id="leftCard">
          <div id="leftImageContainer" class="image-placeholder">🐦</div>
          <div class="label" id="leftLabel">-</div>
          <div class="sub" id="leftSub">L 키로 선택</div>
          <div class="audio">
            <button id="leftPlay" aria-label="왼쪽 재생/일시정지">▶︎/⏸</button>
            <div class="progress" style="flex:1">
              <div class="bar" id="leftBar"></div>
            </div>
          </div>
        </div>
        <div class="vs">VS</div>
        <div class="card" id="rightCard">
          <div id="rightImageContainer" class="image-placeholder">🐦</div>
          <div class="label" id="rightLabel">-</div>
          <div class="sub" id="rightSub">R 키로 선택</div>
          <div class="audio">
            <button id="rightPlay" aria-label="오른쪽 재생/일시정지">▶︎/⏸</button>
            <div class="progress" style="flex:1">
              <div class="bar" id="rightBar"></div>
            </div>
          </div>
        </div>
      </div>

      <div class="actions">
        <button id="chooseLeft" class="btn">⬅ 왼쪽 선택 (L)</button>
        <button id="chooseRight" class="btn">오른쪽 선택 (R) ➡</button>
      </div>
      <button id="nextBtn" class="next btn-secondary">다음 매치 (Enter)</button>

      <div class="bracket" id="bracket"></div>

      <div class="footer">
        <div>단축키: <code>L</code>/<code>R</code> 선택, <code>Space</code> 재생/일시정지, <code>Enter</code> 다음</div>
        <div id="winnerBanner"></div>
      </div>
    </div>
    
    <!-- 올림픽 단상 스타일 순위 표시 -->
    <div class="podium" id="podium">
      <div class="podium-title">🏆 새소리 월드컵 결과 🏆</div>
      <div class="podium-container">
        <div class="podium-place second-place">
          <div class="podium-image-container">
            <div class="image-placeholder" id="secondPlaceImage">🐦</div>
          </div>
          <div class="podium-base">
            <div class="podium-rank">2등</div>
            <div class="podium-name" id="secondPlaceName">-</div>
          </div>
        </div>
        <div class="podium-place first-place">
          <div class="podium-image-container">
            <div class="image-placeholder" id="firstPlaceImage">🐦</div>
          </div>
          <div class="podium-base">
            <div class="podium-rank">1등</div>
            <div class="podium-name" id="firstPlaceName">-</div>
          </div>
        </div>
        <div class="podium-place third-place">
          <div class="podium-image-container">
            <div class="image-placeholder" id="thirdPlaceImage">🐦</div>
          </div>
          <div class="podium-base">
            <div class="podium-rank">3등</div>
            <div class="podium-name" id="thirdPlaceName">-</div>
          </div>
        </div>
      </div>
    </div>

    <audio id="leftAudio"></audio>
    <audio id="rightAudio"></audio>
  </div>

  <script>
    // ======== 설정(수정 가능) ========
    // 1) URL(또는 파일) 없이도 미리보기 되도록 더미 항목을 넣어둡니다.
    // 실제 사용 시 아래 배열을 12개 항목으로 교체하거나, 상단의 "파일 불러오기"로 로컬 파일을 택하세요.
    const DEFAULT_SOUNDS = [
      { name: "큰부리까마귀", src: "sound/12_큰부리까마귀.mp3", searchTerm: "crow" },
      { name: "박새", src: "sound/13_박새.mp3", searchTerm: "tit bird" },
      { name: "곤줄박이", src: "sound/15_곤줄박이.mp3", searchTerm: "marsh tit" },
      { name: "쇠박새", src: "sound/16_쇠박새.mp3", searchTerm: "coal tit" },
      { name: "굴뚝새", src: "sound/21_굴뚝새.mp3", searchTerm: "wren" },
      { name: "되지빠귀", src: "sound/22_되지빠귀.mp3", searchTerm: "thrush" },
      { name: "딱새", src: "sound/25_딱새.mp3", searchTerm: "robin" },
      { name: "노랑할미새", src: "sound/27_노랑할미새.mp3", searchTerm: "wagtail" },
      { name: "노랑턱멧새", src: "sound/30_노랑턱멧새.mp3", searchTerm: "bunting" },
      { name: "검은등뻐꾸기", src: "sound/4_검은등뻐꾸기.mp3", searchTerm: "cuckoo" },
      { name: "뻐꾸기", src: "sound/5_뻐꾸기.mp3", searchTerm: "cuckoo" },
      { name: "꾀꼬리", src: "sound/9_꾀꼬리.mp3", searchTerm: "oriole" },
    ];

    // ======== 로직 시작 ========
    const leftAudio = document.getElementById('leftAudio');
    const rightAudio = document.getElementById('rightAudio');
    const leftPlay = document.getElementById('leftPlay');
    const rightPlay = document.getElementById('rightPlay');
    const leftBar = document.getElementById('leftBar');
    const rightBar = document.getElementById('rightBar');

    const leftLabel = document.getElementById('leftLabel');
    const rightLabel = document.getElementById('rightLabel');
    const leftCard = document.getElementById('leftCard');
    const rightCard = document.getElementById('rightCard');
    const leftImageContainer = document.getElementById('leftImageContainer');
    const rightImageContainer = document.getElementById('rightImageContainer');

    const roundNameEl = document.getElementById('roundName');
    const matchIndexEl = document.getElementById('matchIndex');
    const matchTotalEl = document.getElementById('matchTotal');
    const remainingEl = document.getElementById('remaining');
    const bracketEl = document.getElementById('bracket');
    const winnerBanner = document.getElementById('winnerBanner');
    const roundTitle = document.getElementById('roundTitle');
    const stage = document.querySelector('.stage');
    const podium = document.getElementById('podium');
    const firstPlaceImage = document.getElementById('firstPlaceImage');
    const secondPlaceImage = document.getElementById('secondPlaceImage');
    const thirdPlaceImage = document.getElementById('thirdPlaceImage');
    const firstPlaceName = document.getElementById('firstPlaceName');
    const secondPlaceName = document.getElementById('secondPlaceName');
    const thirdPlaceName = document.getElementById('thirdPlaceName');

    const chooseLeftBtn = document.getElementById('chooseLeft');
    const chooseRightBtn = document.getElementById('chooseRight');
    const nextBtn = document.getElementById('nextBtn');
    const shuffleBtn = document.getElementById('shuffleBtn');
    const restartBtn = document.getElementById('restartBtn');
    const exportBtn = document.getElementById('exportBtn');
    const fileInput = document.getElementById('fileInput');

    let state = {
      participants: [],
      currentRound: [],
      nextRound: [],
      index: 0,
      left: null,
      right: null,
      roundNumber: 1,
      history: [], // 각 라운드의 매치 기록
      rankings: [], // 순위 기록 (3등, 2등, 1등 순)
    };

    function shuffle(arr) {
      const a = [...arr];
      for (let i = a.length - 1; i > 0; i--) {
        const j = Math.floor(Math.random() * (i + 1));
        [a[i], a[j]] = [a[j], a[i]];
      }
      return a;
    }

    function roundLabel(n, size) {
      if (size === 1) return '결승';
      if (size === 2) return '결승';
      if (size === 4) return '4강';
      if (size === 8) return '8강';
      if (size === 16) return '16강';
      return `라운드 ${n}`;
    }

    function createPairs(list) {
      // 홀수면 마지막 하나는 부전승(byes)
      const pairs = [];
      for (let i = 0; i < list.length - 1; i += 2) {
        pairs.push([list[i], list[i + 1]]);
      }
      const bye = list.length % 2 === 1 ? list[list.length - 1] : null;
      return { pairs, bye };
    }

    function updateStatus() {
      const remaining = state.currentRound.length - state.index * 2;
      const totalMatches = Math.ceil(state.currentRound.length / 2);
      const roundName = roundLabel(state.roundNumber, state.currentRound.length);
      
      // 라운드 제목 업데이트
      roundTitle.textContent = roundName;
      
      // 라운드별 배경색 적용
      stage.className = 'stage';
      if (state.currentRound.length <= 2) {
        stage.classList.add('final');
      } else if (state.currentRound.length <= 4) {
        stage.classList.add('round-4');
      } else if (state.currentRound.length <= 8) {
        stage.classList.add('round-3');
      } else if (state.currentRound.length <= 16) {
        stage.classList.add('round-2');
      } else {
        stage.classList.add('round-1');
      }
      
      matchIndexEl.textContent = Math.min(state.index + 1, totalMatches);
      matchTotalEl.textContent = totalMatches;
      remainingEl.textContent = state.currentRound.length;

      bracketEl.innerHTML = '';
      state.currentRound.forEach((p, i) => {
        const div = document.createElement('div');
        div.className = 'chip';
        div.textContent = `${i + 1}. ${p.name}`;
        bracketEl.appendChild(div);
      });
    }

    function loadMatch() {
      const i = state.index * 2;
      state.left = state.currentRound[i] || null;
      state.right = state.currentRound[i + 1] || null;

      leftCard.classList.remove('winner');
      rightCard.classList.remove('winner');

      if (!state.left && !state.right) {
        // 라운드 종료 → 다음 라운드로
        advanceRound();
        return;
      }

      if (state.left && !state.right) {
        // 부전승 처리
        state.nextRound.push(state.left);
        state.history[state.roundNumber - 1].push({ left: state.left.name, right: null, winner: state.left.name });
        state.index++;
        loadMatch();
        return;
      }

      leftLabel.textContent = state.left?.name ?? '-';
      rightLabel.textContent = state.right?.name ?? '-';

      leftAudio.src = state.left?.src || '';
      rightAudio.src = state.right?.src || '';
      leftAudio.pause(); rightAudio.pause();
      leftAudio.currentTime = 0; rightAudio.currentTime = 0;
      leftBar.style.width = '0%'; rightBar.style.width = '0%';

      // 새 이미지 로드
      loadBirdImage(state.left, leftImageContainer);
      loadBirdImage(state.right, rightImageContainer);

      updateStatus();
      winnerBanner.textContent = '';
    }

    function advanceRound() {
      // 4강에서 결승으로 넘어갈 때 3-4위전 결과 기록
      if (state.currentRound.length === 4 && state.nextRound.length === 2) {
        // 4강 탈락자들을 3등으로 기록
        const losers = state.currentRound.filter(p => !state.nextRound.includes(p));
        state.rankings.push(...losers);
      }
      
      // 우승자만 남겨 다음 라운드 구성
      if (state.nextRound.length === 1) {
        // 최종 우승 - 결승 탈락자를 2등으로, 우승자를 1등으로 기록
        const champion = state.nextRound[0];
        const runnerUp = state.currentRound.find(p => p !== champion);
        if (runnerUp) state.rankings.push(runnerUp); // 2등
        state.rankings.push(champion); // 1등
        
        showPodium();
        return;
      }
      state.currentRound = [...state.nextRound];
      state.nextRound = [];
      state.index = 0;
      state.roundNumber++;
      state.history.push([]);
      loadMatch();
    }
    
    function showPodium() {
      document.querySelector('.stage').style.display = 'none';
      podium.classList.add('show');
      
      // 순위별 표시 (rankings 배열의 마지막 3개가 3등, 2등, 1등)
      const rankings = state.rankings;
      const thirdPlace = rankings[rankings.length - 3];
      const secondPlace = rankings[rankings.length - 2];
      const firstPlace = rankings[rankings.length - 1];
      
      if (thirdPlace) {
        thirdPlaceName.textContent = thirdPlace.name;
        loadPodiumImage(thirdPlace, thirdPlaceImage);
      }
      if (secondPlace) {
        secondPlaceName.textContent = secondPlace.name;
        loadPodiumImage(secondPlace, secondPlaceImage);
      }
      if (firstPlace) {
        firstPlaceName.textContent = firstPlace.name;
        loadPodiumImage(firstPlace, firstPlaceImage);
      }
    }
    
    async function loadPodiumImage(bird, container) {
      try {
        const response = await fetch(`https://api.unsplash.com/search/photos?query=${encodeURIComponent(bird.searchTerm)}&per_page=1&client_id=zlALDHYOuXIZiAaOKhrzB0Qp5-gNFwJTKRywbB1JFO0`);
        const data = await response.json();
        
        if (data.results && data.results.length > 0) {
          const imageUrl = data.results[0].urls.small;
          container.innerHTML = `<img src="${imageUrl}" alt="${bird.name}" class="podium-image" onerror="this.parentElement.innerHTML='🐦'; this.parentElement.className='image-placeholder';">`;
          container.className = '';
        } else {
          container.innerHTML = '🐦';
          container.className = 'image-placeholder';
        }
      } catch (error) {
        console.error('이미지 로드 실패:', error);
        container.innerHTML = '🐦';
        container.className = 'image-placeholder';
      }
    }

    function choose(side) {
      if (!state.left || !state.right) return;
      const winner = side === 'left' ? state.left : state.right;
      const loser = side === 'left' ? state.right : state.left;
      state.nextRound.push(winner);
      state.history[state.roundNumber - 1].push({ left: state.left.name, right: state.right.name, winner: winner.name });
      if (side === 'left') { leftCard.classList.add('winner'); rightCard.classList.remove('winner'); }
      else { rightCard.classList.add('winner'); leftCard.classList.remove('winner'); }
    }

    function nextMatch() {
      if (!state.left && !state.right) return;
      // 선택 없이 넘기면 부전승 처리(왼쪽)
      if (state.left && state.right && !leftCard.classList.contains('winner') && !rightCard.classList.contains('winner')) {
        choose('left');
      }
      state.index++;
      loadMatch();
    }

    function init(participants) {
      // 12개 등 임의 참가자 수를 지원. 무작위 섞기
      const list = shuffle(participants);
      state.participants = list;
      state.currentRound = [...list];
      state.nextRound = [];
      state.index = 0;
      state.roundNumber = 1;
      state.history = [[]];
      state.rankings = [];
      
      // UI 초기화
      document.querySelector('.stage').style.display = 'block';
      podium.classList.remove('show');
      
      loadMatch();
    }

    // 진행 바 업데이트
    leftAudio.addEventListener('timeupdate', () => {
      if (leftAudio.duration) leftBar.style.width = `${(leftAudio.currentTime / leftAudio.duration) * 100}%`;
    });
    rightAudio.addEventListener('timeupdate', () => {
      if (rightAudio.duration) rightBar.style.width = `${(rightAudio.currentTime / rightAudio.duration) * 100}%`;
    });

    function toggle(audio, other) {
      if (!audio.src) return;
      if (other && !other.paused) other.pause();
      if (audio.paused) audio.play(); else audio.pause();
    }

    leftPlay.addEventListener('click', () => toggle(leftAudio, rightAudio));
    rightPlay.addEventListener('click', () => toggle(rightAudio, leftAudio));

    chooseLeftBtn.addEventListener('click', () => choose('left'));
    chooseRightBtn.addEventListener('click', () => choose('right'));
    nextBtn.addEventListener('click', nextMatch);

    shuffleBtn.addEventListener('click', () => {
      state.currentRound = shuffle(state.currentRound);
      state.index = 0; state.nextRound = []; state.history[state.roundNumber - 1] = [];
      loadMatch();
    });

    restartBtn.addEventListener('click', () => init(state.participants.length ? state.participants : DEFAULT_SOUNDS));

    exportBtn.addEventListener('click', () => {
      const data = {
        rounds: state.history,
        finalists: state.nextRound.map(p => p.name),
      };
      const blob = new Blob([JSON.stringify(data, null, 2)], { type: 'application/json' });
      const url = URL.createObjectURL(blob);
      const a = document.createElement('a');
      a.href = url; a.download = 'birdcup_result.json'; a.click();
      URL.revokeObjectURL(url);
    });

    // 파일 불러오기: 로컬 파일을 12개 선택하면 참가자 자동 구성
    fileInput.addEventListener('change', async (e) => {
      const files = Array.from(e.target.files).filter(f => f.type.startsWith('audio/'));
      if (!files.length) return;
      const list = files.map(f => ({ name: prettyName(f.name), src: URL.createObjectURL(f) }));
      init(list);
    });

    function prettyName(filename) {
      return filename.replace(/\.[^.]+$/, '') // 확장자 제거
                     .replace(/[\._-]+/g, ' ') // 구분자 공백화
                     .trim();
    }

    // 키보드 단축키
    window.addEventListener('keydown', (e) => {
      if (['INPUT', 'TEXTAREA'].includes(document.activeElement.tagName)) return;
      if (e.key.toLowerCase() === 'l') { e.preventDefault(); choose('left'); }
      if (e.key.toLowerCase() === 'r') { e.preventDefault(); choose('right'); }
      if (e.key === ' ') { e.preventDefault();
        // 최근에 눌렀던 쪽 토글: 우선 오른쪽이 재생 중이면 오른쪽, 아니면 왼쪽
        if (!rightAudio.paused || (leftAudio.paused && rightAudio.paused)) toggle(leftAudio, rightAudio);
        else toggle(rightAudio, leftAudio);
      }
      if (e.key === 'Enter') { e.preventDefault(); nextMatch(); }
    });

    // 새 이미지 로드 함수 (Unsplash API 사용)
    async function loadBirdImage(bird, container) {
      if (!bird) {
        container.innerHTML = '🐦';
        container.className = 'image-placeholder';
        return;
      }

      try {
        // Unsplash에서 새 이미지 검색 (무료, 저작권 없음)
        const response = await fetch(`https://api.unsplash.com/search/photos?query=${encodeURIComponent(bird.searchTerm)}&per_page=1&client_id=zlALDHYOuXIZiAaOKhrzB0Qp5-gNFwJTKRywbB1JFO0`);
        const data = await response.json();
        
        if (data.results && data.results.length > 0) {
          const imageUrl = data.results[0].urls.small;
          container.innerHTML = `<img src="${imageUrl}" alt="${bird.name}" class="bird-image" onerror="this.parentElement.innerHTML='🐦'; this.parentElement.className='image-placeholder';">`;
          container.className = '';
        } else {
          // 이미지를 찾을 수 없는 경우 일반 새 이미지 사용
          const fallbackResponse = await fetch(`https://api.unsplash.com/search/photos?query=bird&per_page=1&client_id=zlALDHYOuXIZiAaOKhrzB0Qp5-gNFwJTKRywbB1JFO0`);
          const fallbackData = await fallbackResponse.json();
          if (fallbackData.results && fallbackData.results.length > 0) {
            const imageUrl = fallbackData.results[0].urls.small;
            container.innerHTML = `<img src="${imageUrl}" alt="${bird.name}" class="bird-image" onerror="this.parentElement.innerHTML='🐦'; this.parentElement.className='image-placeholder';">`;
            container.className = '';
          } else {
            container.innerHTML = '🐦';
            container.className = 'image-placeholder';
          }
        }
      } catch (error) {
        console.error('이미지 로드 실패:', error);
        container.innerHTML = '🐦';
        container.className = 'image-placeholder';
      }
    }

    // 시작
    init(DEFAULT_SOUNDS);
  </script>
</body>
</html>
