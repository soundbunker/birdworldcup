<!doctype html>
<html lang="ko">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>ÏÉàÏÜåÎ¶¨ Ïù¥ÏÉÅÌòïÏõîÎìúÏªµ (12Í∞ú)</title>
  <style>
    :root {
      --bg: #0b0f14;
      --card: #121826;
      --muted: #94a3b8;
      --text: #e5e7eb;
      --accent: #60a5fa;
      --accent-2: #34d399;
      --danger: #f87171;
      --ring: rgba(96,165,250,.45);
      --radius: 16px;
      
      /* ÎùºÏö¥ÎìúÎ≥Ñ Î∞∞Í≤ΩÏÉâ */
      --round1-bg: rgba(59, 130, 246, 0.15);
      --round2-bg: rgba(239, 68, 68, 0.15);
      --round3-bg: rgba(34, 197, 94, 0.15);
      --round4-bg: rgba(168, 85, 247, 0.15);
      --final-bg: rgba(251, 191, 36, 0.15);
    }
    * { box-sizing: border-box; }
    html, body { height: 100%; }
    body {
      margin: 0; font-family: ui-sans-serif, system-ui, -apple-system, "Segoe UI", Roboto, "Helvetica Neue", Arial, "Apple SD Gothic Neo", "Noto Sans KR", "Malgun Gothic", sans-serif;
      background: radial-gradient(1200px 800px at 20% -20%, #1f2937 0%, transparent 60%),
                  radial-gradient(1000px 700px at 120% 0%, #0f172a 0%, transparent 65%),
                  var(--bg);
      color: var(--text);
      display: flex; align-items: center; justify-content: center;
      padding: 12px;
      min-height: 100vh;
      overflow-x: hidden;
    }
    .app { width: 100%; max-width: 1100px; min-height: 100%; }
    header { display:flex; align-items:center; justify-content:space-between; gap: 8px; margin-bottom: 12px; flex-wrap: wrap; }
    h1 { margin: 0; font-size: clamp(16px, 4vw, 28px); font-weight: 800; letter-spacing: 0.2px; line-height: 1.2; }
    .toolbar { display:flex; flex-wrap: wrap; gap: 6px; }
    button, .btn {
      background: linear-gradient(180deg, #1f2937, #0b1220);
      color: var(--text); border: 1px solid #1f2a44; padding: 12px 16px; border-radius: 12px;
      cursor: pointer; font-weight: 600; transition: .2s ease; font-size: 14px;
      min-height: 44px; /* Î™®Î∞îÏùº ÌÑ∞Ïπò ÏπúÌôîÏ†Å */
      display: flex; align-items: center; justify-content: center;
      touch-action: manipulation; /* Î™®Î∞îÏùº ÌÑ∞Ïπò ÏµúÏ†ÅÌôî */
    }
    button:hover { border-color: var(--accent); box-shadow: 0 0 0 4px var(--ring); }
    .btn-secondary { background: #111827; }
    .btn-danger { border-color: #402227; background: #1a0f12; color: #fecaca; }

    .stage { background: rgba(17,24,39,.6); border: 1px solid #1f2a44; border-radius: var(--radius); padding: 16px; transition: background 0.5s ease; }
    .stage.round-1 { background: var(--round1-bg); border-color: rgba(59, 130, 246, 0.3); }
    .stage.round-2 { background: var(--round2-bg); border-color: rgba(239, 68, 68, 0.3); }
    .stage.round-3 { background: var(--round3-bg); border-color: rgba(34, 197, 94, 0.3); }
    .stage.round-4 { background: var(--round4-bg); border-color: rgba(168, 85, 247, 0.3); }
    .stage.final { background: var(--final-bg); border-color: rgba(251, 191, 36, 0.3); }
    .status { display:flex; align-items:center; justify-content:space-between; gap: 8px; margin-bottom: 12px; font-size: 13px; color: var(--muted); flex-wrap: wrap; }
    .status b { color: var(--text); }
    .round-title { font-size: clamp(20px, 5vw, 36px); font-weight: 900; text-align: center; margin-bottom: 16px; color: var(--text); text-shadow: 0 2px 4px rgba(0,0,0,0.5); line-height: 1.2; }

    .versus { display:grid; grid-template-columns: 1fr auto 1fr; gap: 8px; align-items: stretch; }
    .card { background: var(--card); border: 1px solid #1f2a44; border-radius: var(--radius); padding: 12px; display:flex; flex-direction:column; gap: 8px; position: relative; min-height: 240px; cursor: pointer; transition: transform 0.2s ease, box-shadow 0.2s ease; }
    .card:active { transform: scale(0.98); }
    .bird-image { width: 100%; height: 120px; object-fit: cover; border-radius: 8px; background: #1f2937; border: 1px solid #374151; }
    .image-placeholder { width: 100%; height: 120px; background: linear-gradient(135deg, #1f2937, #374151); border-radius: 8px; display: flex; align-items: center; justify-content: center; color: var(--muted); font-size: 20px; border: 1px solid #374151; }
    .card.winner { outline: 3px solid var(--accent-2); }
    .label { font-weight: 800; font-size: clamp(14px, 3vw, 18px); line-height: 1.2; text-align: center; }
    .sub { color: var(--muted); font-size: 11px; text-align: center; }

    .audio { display:flex; align-items:center; gap: 8px; }
    .audio button { padding: 10px 12px; min-height: 40px; }
    .progress { height: 6px; background:#111827; border-radius: 999px; overflow: hidden; border: 1px solid #1f2a44; }
    .bar { height: 100%; width: 0%; background: linear-gradient(90deg, var(--accent), #22d3ee); }

    .vs { display:flex; align-items:center; justify-content:center; font-weight:900; font-size: clamp(20px, 5vw, 28px); color:#cbd5e1; }

    .card-button { width: 100%; margin-top: 8px; padding: 12px; font-size: 14px; min-height: 44px; background: linear-gradient(180deg, var(--accent), #1e40af); border: 1px solid var(--accent); color: white; font-weight: 700; }
    .card-button:hover { background: linear-gradient(180deg, #3b82f6, var(--accent)); border-color: #3b82f6; }
    .card-button:active { transform: scale(0.98); }
    .next { width: 100%; margin-top: 12px; padding: 14px; font-size: 14px; min-height: 48px; }


    .footer { margin-top: 12px; color: var(--muted); font-size: 11px; display:flex; justify-content: space-between; gap: 8px; flex-wrap: wrap; }
    .footer code { background:#0b1220; padding:2px 6px; border-radius:6px; border:1px solid #1f2a44; }
    .copyright { margin-top: 20px; text-align: center; color: var(--muted); font-size: 11px; border-top: 1px solid #1f2a44; padding-top: 12px; }
    .copyright a { color: var(--accent); text-decoration: none; }
    .copyright a:hover { text-decoration: underline; }

    .hidden { display: none; }
    
    /* Ïò¨Î¶ºÌîΩ Îã®ÏÉÅ Ïä§ÌÉÄÏùº */
    .podium { display: none; flex-direction: column; align-items: center; gap: 20px; padding: 30px; position: relative; overflow: hidden; }
    .podium.show { display: flex; }
    .podium-title { font-size: clamp(28px, 5vw, 42px); font-weight: 900; color: var(--text); text-shadow: 0 2px 8px rgba(0,0,0,0.7); margin-bottom: 20px; }
    .podium-container { display: flex; align-items: end; gap: 15px; justify-content: center; flex-wrap: wrap; }
    .podium-place { display: flex; flex-direction: column; align-items: center; position: relative; opacity: 0; transform: translateY(50px); transition: all 0.8s ease; }
    .podium-place.show { opacity: 1; transform: translateY(0); }
    .podium-image { width: 120px; height: 120px; border-radius: 50%; object-fit: cover; border: 4px solid; margin-bottom: 10px; }
    .podium-base { display: flex; flex-direction: column; align-items: center; justify-content: center; border-radius: 8px; padding: 15px 20px; position: relative; }
    .podium-rank { font-size: 24px; font-weight: 900; margin-bottom: 5px; }
    .podium-name { font-size: 16px; font-weight: 600; text-align: center; }
    
    .first-place .podium-image { border-color: #ffd700; box-shadow: 0 0 20px rgba(255, 215, 0, 0.5); }
    .first-place .podium-base { background: linear-gradient(145deg, #ffd700, #ffed4a); color: #1a1a1a; height: 100px; }
    .first-place .podium-rank::before { content: 'ü•á '; }
    
    .second-place .podium-image { border-color: #c0c0c0; box-shadow: 0 0 15px rgba(192, 192, 192, 0.5); }
    .second-place .podium-base { background: linear-gradient(145deg, #c0c0c0, #e5e5e5); color: #1a1a1a; height: 80px; }
    .second-place .podium-rank::before { content: 'ü•à '; }
    
    /* Ìè≠Ï£Ω Ìö®Í≥º */
    .fireworks { position: absolute; top: 0; left: 0; width: 100%; height: 100%; pointer-events: none; overflow: hidden; }
    .firework { position: absolute; width: 6px; height: 6px; border-radius: 50%; }
    
    @keyframes explode {
      0% {
        transform: scale(0) rotate(0deg);
        opacity: 1;
      }
      100% {
        transform: scale(15) rotate(180deg);
        opacity: 0;
      }
    }
    
    @keyframes sparkle {
      0%, 100% {
        transform: scale(0);
        opacity: 0;
      }
      50% {
        transform: scale(1);
        opacity: 1;
      }
    }
    
    .firework {
      animation: explode 1.5s ease-out forwards;
    }
    
    .sparkle {
      position: absolute;
      width: 4px;
      height: 4px;
      background: #ffd700;
      border-radius: 50%;
      animation: sparkle 0.8s ease-in-out infinite;
    }
    
    .third-place .podium-image { border-color: #cd7f32; box-shadow: 0 0 15px rgba(205, 127, 50, 0.5); }
    .third-place .podium-base { background: linear-gradient(145deg, #cd7f32, #daa520); color: #1a1a1a; height: 60px; }
    .third-place .podium-rank::before { content: 'ü•â '; }
    
    /* Î™®Î∞îÏùº ÏµúÏ†ÅÌôî */
    @media (max-width: 768px) {
      body { padding: 8px; }
      .app { padding: 0; }
      header { flex-direction: column; align-items: stretch; gap: 12px; }
      .toolbar { justify-content: center; }
      .versus { grid-template-columns: 1fr; gap: 12px; }
      .vs { order: -1; font-size: 24px; padding: 8px 0; }
      .card { min-height: 200px; padding: 10px; }
      .bird-image, .image-placeholder { height: 100px; }
      .card-button { font-size: 15px; padding: 14px 12px; }
      .next { padding: 16px; font-size: 15px; }
      .stage { padding: 12px; }
      .round-title { margin-bottom: 12px; }
      .podium-container { flex-direction: column; align-items: center; gap: 20px; }
      .podium-place { margin-bottom: 0; }
      .podium-image { width: 100px; height: 100px; }
      .copyright { font-size: 10px; padding-top: 8px; }
    }
    
    @media (max-width: 480px) {
      .toolbar { flex-direction: column; }
      .toolbar button, .toolbar .btn { width: 100%; }
      .card { min-height: 180px; }
      .bird-image, .image-placeholder { height: 80px; font-size: 18px; }
      .label { font-size: 13px; }
      .sub { font-size: 10px; }
      .vs { font-size: 20px; }
      .card-button { font-size: 14px; padding: 12px 8px; }
      .podium-title { font-size: 20px; }
    }
  </style>
</head>
<body>
  <div class="app">
    <header>
      <h1>üïäÔ∏è ÏÉàÏÜåÎ¶¨ Ïù¥ÏÉÅÌòïÏõîÎìúÏªµ</h1>
      <div class="toolbar">
        <label class="btn btn-secondary" title="Ïò§ÎîîÏò§ÏôÄ Ïù¥ÎØ∏ÏßÄ ÌååÏùºÏùÑ ÏÑ†ÌÉùÌï¥ Î∞îÎ°ú ÏãúÏûë">
          ÌååÏùº Î∂àÎü¨Ïò§Í∏∞<input id="fileInput" type="file" accept="audio/*,image/*" multiple class="hidden" />
        </label>
        <button id="shuffleBtn" class="btn btn-secondary" title="ÌòÑÏû¨ ÎùºÏö¥Îìú Ï∞∏Í∞ÄÏûê ÏÑûÍ∏∞">ÏÖîÌîå</button>
        <button id="restartBtn" class="btn btn-secondary" title="Ï≤òÏùåÎ∂ÄÌÑ∞ Îã§Ïãú">Ï≤òÏùåÎ∂ÄÌÑ∞</button>
        <button id="exportBtn" class="btn" title="Í≤∞Í≥ºÎ•º JSONÏúºÎ°ú Ï†ÄÏû•">Í≤∞Í≥º ÎÇ¥Î≥¥ÎÇ¥Í∏∞</button>
      </div>
    </header>

    <div class="stage">
      <div class="round-title" id="roundTitle">-</div>
      <div class="status">
        <div>Îß§Ïπò <b id="matchIndex">0</b>/<b id="matchTotal">0</b></div>
        <div>ÎÇ®ÏùÄ Ï∞∏Í∞ÄÏûê: <b id="remaining">0</b></div>
      </div>

      <div class="versus">
        <div class="card" id="leftCard">
          <div id="leftImageContainer" class="image-placeholder">üê¶</div>
          <div class="label" id="leftLabel">-</div>
          <div class="sub" id="leftSub">Ïù¥ ÏÉàÏÜåÎ¶¨Î•º Îì§Ïñ¥Î≥¥ÏÑ∏Ïöî</div>
          <div class="audio">
            <button id="leftPlay" aria-label="Ïû¨ÏÉù/ÏùºÏãúÏ†ïÏßÄ">‚ñ∂Ô∏é/‚è∏</button>
            <div class="progress" style="flex:1">
              <div class="bar" id="leftBar"></div>
            </div>
          </div>
          <button class="card-button" id="chooseLeft">Ïù¥ ÏÉàÎ•º ÏÑ†ÌÉùÌïòÍ∏∞</button>
        </div>
        <div class="vs">VS</div>
        <div class="card" id="rightCard">
          <div id="rightImageContainer" class="image-placeholder">üê¶</div>
          <div class="label" id="rightLabel">-</div>
          <div class="sub" id="rightSub">Ïù¥ ÏÉàÏÜåÎ¶¨Î•º Îì§Ïñ¥Î≥¥ÏÑ∏Ïöî</div>
          <div class="audio">
            <button id="rightPlay" aria-label="Ïû¨ÏÉù/ÏùºÏãúÏ†ïÏßÄ">‚ñ∂Ô∏é/‚è∏</button>
            <div class="progress" style="flex:1">
              <div class="bar" id="rightBar"></div>
            </div>
          </div>
          <button class="card-button" id="chooseRight">Ïù¥ ÏÉàÎ•º ÏÑ†ÌÉùÌïòÍ∏∞</button>
        </div>
      </div>

      <button id="nextBtn" class="next btn-secondary hidden">Îã§Ïùå Îß§Ïπò (Enter)</button>

      <div class="footer">
        <div>Îã®Ï∂ïÌÇ§: <code>L</code>/<code>R</code> ÏÑ†ÌÉù, <code>Space</code> Ïû¨ÏÉù/ÏùºÏãúÏ†ïÏßÄ</div>
        <div id="winnerBanner"></div>
      </div>
    </div>
    
    <!-- Ïò¨Î¶ºÌîΩ Îã®ÏÉÅ Ïä§ÌÉÄÏùº ÏàúÏúÑ ÌëúÏãú -->
    <div class="podium" id="podium">
      <div class="podium-title">üèÜ ÏÉàÏÜåÎ¶¨ ÏõîÎìúÏªµ Í≤∞Í≥º üèÜ</div>
      <div class="fireworks" id="fireworks"></div>
      <div class="podium-container">
        <div class="podium-place first-place" id="firstPlaceElement">
          <div class="podium-image-container">
            <div class="image-placeholder" id="firstPlaceImage">üê¶</div>
          </div>
          <div class="podium-base">
            <div class="podium-rank">1Îì±</div>
            <div class="podium-name" id="firstPlaceName">-</div>
          </div>
        </div>
        <div class="podium-place second-place" id="secondPlaceElement">
          <div class="podium-image-container">
            <div class="image-placeholder" id="secondPlaceImage">üê¶</div>
          </div>
          <div class="podium-base">
            <div class="podium-rank">2Îì±</div>
            <div class="podium-name" id="secondPlaceName">-</div>
          </div>
        </div>
      </div>
      
      <div class="copyright">
        ¬© 2024 TheSoundBunker inc. All rights reserved. | Î¨∏Ïùò: <a href="mailto:play@soundb.kr">play@soundb.kr</a>
      </div>
    </div>

    <audio id="leftAudio"></audio>
    <audio id="rightAudio"></audio>
    <audio id="victoryAudio" preload="auto"></audio>
    
    <div class="copyright">
      ¬© 2024 TheSoundBunker inc. All rights reserved. | Î¨∏Ïùò: <a href="mailto:play@soundb.kr">play@soundb.kr</a>
    </div>
  </div>

  <script>
    // ======== ÏÑ§Ï†ï(ÏàòÏ†ï Í∞ÄÎä•) ========
    // 1) URL(ÎòêÎäî ÌååÏùº) ÏóÜÏù¥ÎèÑ ÎØ∏Î¶¨Î≥¥Í∏∞ ÎêòÎèÑÎ°ù ÎçîÎØ∏ Ìï≠Î™©ÏùÑ ÎÑ£Ïñ¥Îë°ÎãàÎã§.
    // Ïã§Ï†ú ÏÇ¨Ïö© Ïãú ÏïÑÎûò Î∞∞Ïó¥ÏùÑ 12Í∞ú Ìï≠Î™©ÏúºÎ°ú ÍµêÏ≤¥ÌïòÍ±∞ÎÇò, ÏÉÅÎã®Ïùò "ÌååÏùº Î∂àÎü¨Ïò§Í∏∞"Î°ú Î°úÏª¨ ÌååÏùºÏùÑ ÌÉùÌïòÏÑ∏Ïöî.
    const DEFAULT_SOUNDS = [
      { name: "ÌÅ∞Î∂ÄÎ¶¨ÍπåÎßàÍ∑Ä", src: "sound/12_ÌÅ∞Î∂ÄÎ¶¨ÍπåÎßàÍ∑Ä.mp3", imageUrl: "images/12_ÌÅ∞Î∂ÄÎ¶¨ÍπåÎßàÍ∑Ä.jpg" },
      { name: "Î∞ïÏÉà", src: "sound/13_Î∞ïÏÉà.mp3", imageUrl: "images/13_Î∞ïÏÉà.jpg" },
      { name: "Í≥§Ï§ÑÎ∞ïÏù¥", src: "sound/15_Í≥§Ï§ÑÎ∞ïÏù¥.mp3", imageUrl: "images/15_Í≥§Ï§ÑÎ∞ïÏù¥.JPG" },
      { name: "Ïá†Î∞ïÏÉà", src: "sound/16_Ïá†Î∞ïÏÉà.mp3", imageUrl: "images/16_Ïá†Î∞ïÏÉà.jpg" },
      { name: "Íµ¥ÎöùÏÉà", src: "sound/21_Íµ¥ÎöùÏÉà.mp3", imageUrl: "images/21_Íµ¥ÎöùÏÉà.png" },
      { name: "ÎêòÏßÄÎπ†Í∑Ä", src: "sound/22_ÎêòÏßÄÎπ†Í∑Ä.mp3", imageUrl: "images/22_ÎêòÏßÄÎπ†Í∑Ä.jpg" },
      { name: "Îî±ÏÉà", src: "sound/25_Îî±ÏÉà.mp3", imageUrl: "images/25_Îî±ÏÉà.jpg" },
      { name: "ÎÖ∏ÎûëÌï†ÎØ∏ÏÉà", src: "sound/27_ÎÖ∏ÎûëÌï†ÎØ∏ÏÉà.mp3", imageUrl: "images/27_ÎÖ∏ÎûëÌï†ÎØ∏ÏÉà.jpg" },
      { name: "ÎÖ∏ÎûëÌÑ±Î©ßÏÉà", src: "sound/30_ÎÖ∏ÎûëÌÑ±Î©ßÏÉà.mp3", imageUrl: "images/30_ÎÖ∏ÎûëÌÑ±Î©ßÏÉà.jpg" },
      { name: "Í≤ÄÏùÄÎì±ÎªêÍæ∏Í∏∞", src: "sound/4_Í≤ÄÏùÄÎì±ÎªêÍæ∏Í∏∞.mp3", imageUrl: "images/4_Í≤ÄÏùÄÎì±ÎªêÍæ∏Í∏∞.png" },
      { name: "ÎªêÍæ∏Í∏∞", src: "sound/5_ÎªêÍæ∏Í∏∞.mp3", imageUrl: "images/5_ÎªêÍæ∏Í∏∞.jpg" },
      { name: "ÍæÄÍº¨Î¶¨", src: "sound/9_ÍæÄÍº¨Î¶¨.mp3", imageUrl: "images/9_ÍæÄÍº¨Î¶¨.jpg" },
    ];

    // ======== Î°úÏßÅ ÏãúÏûë ========
    const leftAudio = document.getElementById('leftAudio');
    const rightAudio = document.getElementById('rightAudio');
    const leftPlay = document.getElementById('leftPlay');
    const rightPlay = document.getElementById('rightPlay');
    const leftBar = document.getElementById('leftBar');
    const rightBar = document.getElementById('rightBar');

    const leftLabel = document.getElementById('leftLabel');
    const rightLabel = document.getElementById('rightLabel');
    const leftCard = document.getElementById('leftCard');
    const rightCard = document.getElementById('rightCard');
    const leftImageContainer = document.getElementById('leftImageContainer');
    const rightImageContainer = document.getElementById('rightImageContainer');

    const roundNameEl = document.getElementById('roundName');
    const matchIndexEl = document.getElementById('matchIndex');
    const matchTotalEl = document.getElementById('matchTotal');
    const remainingEl = document.getElementById('remaining');
    const winnerBanner = document.getElementById('winnerBanner');
    const roundTitle = document.getElementById('roundTitle');
    const stage = document.querySelector('.stage');
    const podium = document.getElementById('podium');
    const firstPlaceImage = document.getElementById('firstPlaceImage');
    const secondPlaceImage = document.getElementById('secondPlaceImage');
    const firstPlaceName = document.getElementById('firstPlaceName');
    const secondPlaceName = document.getElementById('secondPlaceName');
    const firstPlaceElement = document.getElementById('firstPlaceElement');
    const secondPlaceElement = document.getElementById('secondPlaceElement');
    const fireworksContainer = document.getElementById('fireworks');
    const victoryAudio = document.getElementById('victoryAudio');

    const chooseLeftBtn = document.getElementById('chooseLeft');
    const chooseRightBtn = document.getElementById('chooseRight');
    const nextBtn = document.getElementById('nextBtn');
    const shuffleBtn = document.getElementById('shuffleBtn');
    const restartBtn = document.getElementById('restartBtn');
    const exportBtn = document.getElementById('exportBtn');
    const fileInput = document.getElementById('fileInput');

    let state = {
      participants: [],
      currentRound: [],
      nextRound: [],
      index: 0,
      left: null,
      right: null,
      roundNumber: 1,
      history: [], // Í∞Å ÎùºÏö¥ÎìúÏùò Îß§Ïπò Í∏∞Î°ù
      rankings: [], // ÏàúÏúÑ Í∏∞Î°ù (3Îì±, 2Îì±, 1Îì± Ïàú)
    };

    function shuffle(arr) {
      const a = [...arr];
      for (let i = a.length - 1; i > 0; i--) {
        const j = Math.floor(Math.random() * (i + 1));
        [a[i], a[j]] = [a[j], a[i]];
      }
      return a;
    }

    function roundLabel(n, size) {
      if (size === 1) return 'Í≤∞Ïäπ';
      if (size === 2) return 'Í≤∞Ïäπ';
      if (size === 4) return '4Í∞ï';
      if (size === 8) return '8Í∞ï';
      if (size === 16) return '16Í∞ï';
      return `ÎùºÏö¥Îìú ${n}`;
    }

    function createPairs(list) {
      // ÌôÄÏàòÎ©¥ ÎßàÏßÄÎßâ ÌïòÎÇòÎäî Î∂ÄÏ†ÑÏäπ(byes)
      const pairs = [];
      for (let i = 0; i < list.length - 1; i += 2) {
        pairs.push([list[i], list[i + 1]]);
      }
      const bye = list.length % 2 === 1 ? list[list.length - 1] : null;
      return { pairs, bye };
    }

    function updateStatus() {
      const remaining = state.currentRound.length - state.index * 2;
      const totalMatches = Math.ceil(state.currentRound.length / 2);
      const roundName = roundLabel(state.roundNumber, state.currentRound.length);
      
      // ÎùºÏö¥Îìú Ï†úÎ™© ÏóÖÎç∞Ïù¥Ìä∏
      roundTitle.textContent = roundName;
      
      // ÎùºÏö¥ÎìúÎ≥Ñ Î∞∞Í≤ΩÏÉâ Ï†ÅÏö©
      stage.className = 'stage';
      if (state.currentRound.length <= 2) {
        stage.classList.add('final');
      } else if (state.currentRound.length <= 4) {
        stage.classList.add('round-4');
      } else if (state.currentRound.length <= 8) {
        stage.classList.add('round-3');
      } else if (state.currentRound.length <= 16) {
        stage.classList.add('round-2');
      } else {
        stage.classList.add('round-1');
      }
      
      matchIndexEl.textContent = Math.min(state.index + 1, totalMatches);
      matchTotalEl.textContent = totalMatches;
      remainingEl.textContent = state.currentRound.length;

    }

    function loadMatch() {
      const i = state.index * 2;
      state.left = state.currentRound[i] || null;
      state.right = state.currentRound[i + 1] || null;

      leftCard.classList.remove('winner');
      rightCard.classList.remove('winner');

      if (!state.left && !state.right) {
        // ÎùºÏö¥Îìú Ï¢ÖÎ£å ‚Üí Îã§Ïùå ÎùºÏö¥ÎìúÎ°ú
        advanceRound();
        return;
      }

      if (state.left && !state.right) {
        // Î∂ÄÏ†ÑÏäπ Ï≤òÎ¶¨
        state.nextRound.push(state.left);
        state.history[state.roundNumber - 1].push({ left: state.left.name, right: null, winner: state.left.name });
        state.index++;
        loadMatch();
        return;
      }

      leftLabel.textContent = state.left?.name ?? '-';
      rightLabel.textContent = state.right?.name ?? '-';

      leftAudio.src = state.left?.src || '';
      rightAudio.src = state.right?.src || '';
      leftAudio.pause(); rightAudio.pause();
      leftAudio.currentTime = 0; rightAudio.currentTime = 0;
      leftBar.style.width = '0%'; rightBar.style.width = '0%';

      // ÏÉà Ïù¥ÎØ∏ÏßÄ Î°úÎìú
      loadBirdImage(state.left, leftImageContainer);
      loadBirdImage(state.right, rightImageContainer);

      updateStatus();
      winnerBanner.textContent = '';
    }

    function advanceRound() {
      // Ïö∞ÏäπÏûêÎßå ÎÇ®Í≤® Îã§Ïùå ÎùºÏö¥Îìú Íµ¨ÏÑ±
      if (state.nextRound.length === 1) {
        // ÏµúÏ¢Ö Ïö∞Ïäπ - Í≤∞Ïäπ ÌÉàÎùΩÏûêÎ•º 2Îì±ÏúºÎ°ú, Ïö∞ÏäπÏûêÎ•º 1Îì±ÏúºÎ°ú Í∏∞Î°ù
        const champion = state.nextRound[0];
        const runnerUp = state.currentRound.find(p => p !== champion);
        if (runnerUp) state.rankings.push(runnerUp); // 2Îì±
        state.rankings.push(champion); // 1Îì±
        
        showPodium();
        return;
      }
      state.currentRound = [...state.nextRound];
      state.nextRound = [];
      state.index = 0;
      state.roundNumber++;
      state.history.push([]);
      loadMatch();
    }
    
    function showPodium() {
      document.querySelector('.stage').style.display = 'none';
      podium.classList.add('show');
      
      // ÏäπÎ¶¨ Ìö®Í≥ºÏùå Ïû¨ÏÉù
      playVictorySound();
      
      // 1Îì±Í≥º 2Îì± Îç∞Ïù¥ÌÑ∞ Ï§ÄÎπÑ
      const rankings = state.rankings;
      const secondPlace = rankings[rankings.length - 2];
      const firstPlace = rankings[rankings.length - 1];
      
      // 1Îì± Î®ºÏ†Ä ÌëúÏãú (1Ï¥à ÌõÑ)
      setTimeout(() => {
        if (firstPlace) {
          firstPlaceName.textContent = firstPlace.name;
          loadPodiumImage(firstPlace, firstPlaceImage);
          firstPlaceElement.classList.add('show');
          createFireworks();
        }
      }, 1000);
      
      // 2Îì± ÎÇòÏ§ëÏóê ÌëúÏãú (3Ï¥à ÌõÑ)
      setTimeout(() => {
        if (secondPlace) {
          secondPlaceName.textContent = secondPlace.name;
          loadPodiumImage(secondPlace, secondPlaceImage);
          secondPlaceElement.classList.add('show');
        }
      }, 3000);
    }
    
    async function loadPodiumImage(bird, container) {
      try {
        // Î°úÏª¨ Ïù¥ÎØ∏ÏßÄÍ∞Ä ÏûàÏúºÎ©¥ Ïö∞ÏÑ† ÏÇ¨Ïö©
        if (bird.imageUrl) {
          container.innerHTML = `<img src="${bird.imageUrl}" alt="${bird.name}" class="podium-image" onerror="this.parentElement.innerHTML='üê¶'; this.parentElement.className='image-placeholder';">`;
          container.className = '';
          return;
        }

        const birdImageMap = {
          'ÌÅ∞Î∂ÄÎ¶¨ÍπåÎßàÍ∑Ä': '237',
          'Î∞ïÏÉà': '238', 
          'Í≥§Ï§ÑÎ∞ïÏù¥': '239',
          'Ïá†Î∞ïÏÉà': '240',
          'Íµ¥ÎöùÏÉà': '241',
          'ÎêòÏßÄÎπ†Í∑Ä': '242',
          'Îî±ÏÉà': '243',
          'ÎÖ∏ÎûëÌï†ÎØ∏ÏÉà': '244',
          'ÎÖ∏ÎûëÌÑ±Î©ßÏÉà': '245',
          'Í≤ÄÏùÄÎì±ÎªêÍæ∏Í∏∞': '246',
          'ÎªêÍæ∏Í∏∞': '247',
          'ÍæÄÍº¨Î¶¨': '248'
        };
        
        const imageId = birdImageMap[bird.name] || '237';
        const imageUrl = `https://picsum.photos/150/150?random=${imageId}`;
        
        container.innerHTML = `<img src="${imageUrl}" alt="${bird.name}" class="podium-image" onerror="this.parentElement.innerHTML='üê¶'; this.parentElement.className='image-placeholder';">`;
        container.className = '';
        
      } catch (error) {
        console.error('Ïù¥ÎØ∏ÏßÄ Î°úÎìú Ïã§Ìå®:', error);
        container.innerHTML = 'üê¶';
        container.className = 'image-placeholder';
      }
    }

    function choose(side) {
      if (!state.left || !state.right) return;
      const winner = side === 'left' ? state.left : state.right;
      const loser = side === 'left' ? state.right : state.left;
      state.nextRound.push(winner);
      state.history[state.roundNumber - 1].push({ left: state.left.name, right: state.right.name, winner: winner.name });
      if (side === 'left') { leftCard.classList.add('winner'); rightCard.classList.remove('winner'); }
      else { rightCard.classList.add('winner'); leftCard.classList.remove('winner'); }
      
      // ÏÑ†ÌÉù ÌõÑ Ïû†Ïãú ÎåÄÍ∏∞ÌïòÍ≥† ÏûêÎèôÏúºÎ°ú Îã§Ïùå Îß§ÏπòÎ°ú
      setTimeout(() => {
        nextMatch();
      }, 1000);
    }

    function nextMatch() {
      if (!state.left && !state.right) return;
      // ÏÑ†ÌÉù ÏóÜÏù¥ ÎÑòÍ∏∞Î©¥ Î∂ÄÏ†ÑÏäπ Ï≤òÎ¶¨(ÏôºÏ™Ω)
      if (state.left && state.right && !leftCard.classList.contains('winner') && !rightCard.classList.contains('winner')) {
        choose('left');
      }
      state.index++;
      loadMatch();
    }

    function init(participants) {
      // 12Í∞ú Îì± ÏûÑÏùò Ï∞∏Í∞ÄÏûê ÏàòÎ•º ÏßÄÏõê. Î¨¥ÏûëÏúÑ ÏÑûÍ∏∞
      const list = shuffle(participants);
      state.participants = list;
      state.currentRound = [...list];
      state.nextRound = [];
      state.index = 0;
      state.roundNumber = 1;
      state.history = [[]];
      state.rankings = [];
      
      // UI Ï¥àÍ∏∞Ìôî
      document.querySelector('.stage').style.display = 'block';
      podium.classList.remove('show');
      
      loadMatch();
    }

    // ÏßÑÌñâ Î∞î ÏóÖÎç∞Ïù¥Ìä∏
    leftAudio.addEventListener('timeupdate', () => {
      if (leftAudio.duration) leftBar.style.width = `${(leftAudio.currentTime / leftAudio.duration) * 100}%`;
    });
    rightAudio.addEventListener('timeupdate', () => {
      if (rightAudio.duration) rightBar.style.width = `${(rightAudio.currentTime / rightAudio.duration) * 100}%`;
    });

    function toggle(audio, other) {
      if (!audio.src) return;
      if (other && !other.paused) other.pause();
      if (audio.paused) audio.play(); else audio.pause();
    }

    leftPlay.addEventListener('click', () => toggle(leftAudio, rightAudio));
    rightPlay.addEventListener('click', () => toggle(rightAudio, leftAudio));

    chooseLeftBtn.addEventListener('click', () => choose('left'));
    chooseRightBtn.addEventListener('click', () => choose('right'));
    nextBtn.addEventListener('click', nextMatch);

    shuffleBtn.addEventListener('click', () => {
      state.currentRound = shuffle(state.currentRound);
      state.index = 0; state.nextRound = []; state.history[state.roundNumber - 1] = [];
      loadMatch();
    });

    restartBtn.addEventListener('click', () => init(state.participants.length ? state.participants : DEFAULT_SOUNDS));

    exportBtn.addEventListener('click', () => {
      const data = {
        rounds: state.history,
        finalists: state.nextRound.map(p => p.name),
      };
      const blob = new Blob([JSON.stringify(data, null, 2)], { type: 'application/json' });
      const url = URL.createObjectURL(blob);
      const a = document.createElement('a');
      a.href = url; a.download = 'birdcup_result.json'; a.click();
      URL.revokeObjectURL(url);
    });

    // ÌååÏùº Î∂àÎü¨Ïò§Í∏∞: Î°úÏª¨ Ïò§ÎîîÏò§/Ïù¥ÎØ∏ÏßÄ ÌååÏùºÏùÑ ÏÑ†ÌÉùÌïòÎ©¥ Ï∞∏Í∞ÄÏûê ÏûêÎèô Íµ¨ÏÑ±
    fileInput.addEventListener('change', async (e) => {
      const files = Array.from(e.target.files);
      const audioFiles = files.filter(f => f.type.startsWith('audio/'));
      const imageFiles = files.filter(f => f.type.startsWith('image/'));
      
      if (!audioFiles.length) return;
      
      // Ïù¥ÎØ∏ÏßÄ ÌååÏùºÎì§ÏùÑ Ïù¥Î¶ÑÏúºÎ°ú Îß§Ìïë
      const imageMap = new Map();
      imageFiles.forEach(f => {
        const baseName = getBaseName(f.name);
        imageMap.set(baseName, URL.createObjectURL(f));
      });
      
      const list = audioFiles.map(f => {
        const baseName = getBaseName(f.name);
        const imageUrl = imageMap.get(baseName);
        return { 
          name: prettyName(f.name), 
          src: URL.createObjectURL(f),
          imageUrl: imageUrl
        };
      });
      
      init(list);
    });

    function prettyName(filename) {
      return filename.replace(/\.[^.]+$/, '') // ÌôïÏû•Ïûê Ï†úÍ±∞
                     .replace(/[\._-]+/g, ' ') // Íµ¨Î∂ÑÏûê Í≥µÎ∞±Ìôî
                     .trim();
    }

    function getBaseName(filename) {
      // ÌååÏùº Ïù¥Î¶ÑÏóêÏÑú Ïà´ÏûêÎÇò ÌäπÏàòÎ¨∏ÏûêÎ•º Ï†úÍ±∞ÌïòÍ≥† Í∏∞Î≥∏ Ïù¥Î¶ÑÎßå Ï∂îÏ∂ú
      return filename.replace(/\.[^.]+$/, '') // ÌôïÏû•Ïûê Ï†úÍ±∞
                     .replace(/^\d+[._-]*/, '') // ÏïûÏùò Ïà´Ïûê Ï†úÍ±∞
                     .replace(/[._-]+/g, '') // Íµ¨Î∂ÑÏûê Ï†úÍ±∞
                     .toLowerCase()
                     .trim();
    }

    // ÌÇ§Î≥¥Îìú Îã®Ï∂ïÌÇ§
    window.addEventListener('keydown', (e) => {
      if (['INPUT', 'TEXTAREA'].includes(document.activeElement.tagName)) return;
      if (e.key.toLowerCase() === 'l') { e.preventDefault(); choose('left'); }
      if (e.key.toLowerCase() === 'r') { e.preventDefault(); choose('right'); }
      if (e.key === ' ') { e.preventDefault();
        // ÏµúÍ∑ºÏóê ÎàåÎ†ÄÎçò Ï™Ω ÌÜ†Í∏Ä: Ïö∞ÏÑ† Ïò§Î•∏Ï™ΩÏù¥ Ïû¨ÏÉù Ï§ëÏù¥Î©¥ Ïò§Î•∏Ï™Ω, ÏïÑÎãàÎ©¥ ÏôºÏ™Ω
        if (!rightAudio.paused || (leftAudio.paused && rightAudio.paused)) toggle(leftAudio, rightAudio);
        else toggle(rightAudio, leftAudio);
      }
      if (e.key === 'Enter') { e.preventDefault(); nextMatch(); }
    });

    // ÏÉà Ïù¥ÎØ∏ÏßÄ Î°úÎìú Ìï®Ïàò
    async function loadBirdImage(bird, container) {
      if (!bird) {
        container.innerHTML = 'üê¶';
        container.className = 'image-placeholder';
        return;
      }

      try {
        // Î°úÏª¨ Ïù¥ÎØ∏ÏßÄÍ∞Ä ÏûàÏúºÎ©¥ Ïö∞ÏÑ† ÏÇ¨Ïö©
        if (bird.imageUrl) {
          container.innerHTML = `<img src="${bird.imageUrl}" alt="${bird.name}" class="bird-image" onerror="this.parentElement.innerHTML='üê¶'; this.parentElement.className='image-placeholder';">`;
          container.className = '';
          return;
        }

        // Í∏∞Î≥∏ Ïù¥ÎØ∏ÏßÄ (Picsum Photos - Î¨¥Î£å, Ï†ÄÏûëÍ∂å ÏóÜÏùå)
        const birdImageMap = {
          'ÌÅ∞Î∂ÄÎ¶¨ÍπåÎßàÍ∑Ä': '237',
          'Î∞ïÏÉà': '238', 
          'Í≥§Ï§ÑÎ∞ïÏù¥': '239',
          'Ïá†Î∞ïÏÉà': '240',
          'Íµ¥ÎöùÏÉà': '241',
          'ÎêòÏßÄÎπ†Í∑Ä': '242',
          'Îî±ÏÉà': '243',
          'ÎÖ∏ÎûëÌï†ÎØ∏ÏÉà': '244',
          'ÎÖ∏ÎûëÌÑ±Î©ßÏÉà': '245',
          'Í≤ÄÏùÄÎì±ÎªêÍæ∏Í∏∞': '246',
          'ÎªêÍæ∏Í∏∞': '247',
          'ÍæÄÍº¨Î¶¨': '248'
        };
        
        const imageId = birdImageMap[bird.name] || '237';
        const imageUrl = `https://picsum.photos/300/200?random=${imageId}`;
        
        container.innerHTML = `<img src="${imageUrl}" alt="${bird.name}" class="bird-image" onerror="this.parentElement.innerHTML='üê¶'; this.parentElement.className='image-placeholder';">`;
        container.className = '';
      } catch (error) {
        console.error('Ïù¥ÎØ∏ÏßÄ Î°úÎìú Ïã§Ìå®:', error);
        container.innerHTML = 'üê¶';
        container.className = 'image-placeholder';
      }
    }

    // ÏäπÎ¶¨ Ìö®Í≥ºÏùå ÏÉùÏÑ± Î∞è Ïû¨ÏÉù
    function createVictorySound() {
      // Web Audio APIÎ•º ÏÇ¨Ïö©Ìï¥ÏÑú 'Îπ†Î∞§!' Ìö®Í≥ºÏùå ÏÉùÏÑ±
      const audioContext = new (window.AudioContext || window.webkitAudioContext)();
      const duration = 2.0;
      const sampleRate = audioContext.sampleRate;
      const buffer = audioContext.createBuffer(1, duration * sampleRate, sampleRate);
      const data = buffer.getChannelData(0);
      
      // Ìå¨ÌååÎ†à ÏÇ¨Ïö¥Îìú ÏÉùÏÑ± (Îπ†Î∞§ ÎäêÎÇå)
      for (let i = 0; i < data.length; i++) {
        const t = i / sampleRate;
        let sound = 0;
        
        // Ï≤´ Î≤àÏß∏ 'Îπ†' (0.0-0.3Ï¥à)
        if (t < 0.3) {
          const freq = 523 + Math.sin(t * 50) * 100; // C5 + vibrato
          sound += Math.sin(2 * Math.PI * freq * t) * Math.exp(-t * 8) * 0.5;
        }
        // Îëê Î≤àÏß∏ 'Î∞§' (0.4-0.8Ï¥à)
        else if (t > 0.4 && t < 0.8) {
          const t2 = t - 0.4;
          const freq = 659 + Math.sin(t2 * 60) * 120; // E5 + vibrato
          sound += Math.sin(2 * Math.PI * freq * t2) * Math.exp(-t2 * 6) * 0.6;
        }
        // Î¶¨Î≤ÑÎ∏å Ìö®Í≥º
        if (t > 0.8) {
          const t3 = t - 0.8;
          sound += sound * 0.1 * Math.exp(-t3 * 3);
        }
        
        data[i] = Math.max(-1, Math.min(1, sound));
      }
      
      return buffer;
    }
    
    function playVictorySound() {
      try {
        const audioContext = new (window.AudioContext || window.webkitAudioContext)();
        const buffer = createVictorySound();
        const source = audioContext.createBufferSource();
        const gainNode = audioContext.createGain();
        
        source.buffer = buffer;
        gainNode.gain.value = 0.3; // Î≥ºÎ•® Ï°∞Ï†à
        
        source.connect(gainNode);
        gainNode.connect(audioContext.destination);
        
        source.start();
      } catch (error) {
        console.log('Ïò§ÎîîÏò§ Ïû¨ÏÉù Ïã§Ìå®:', error);
        // Ìè¥Î∞±: Í∞ÑÎã®Ìïú ÎπÑÌîÑÏùå
        if (navigator.vibrate) {
          navigator.vibrate([200, 100, 200, 100, 400]);
        }
      }
    }
    
    // Ìè≠Ï£Ω Ìö®Í≥º ÏÉùÏÑ±
    function createFireworks() {
      const colors = ['#ffd700', '#ff6b6b', '#4ecdc4', '#45b7d1', '#96ceb4', '#ffeaa7'];
      
      for (let i = 0; i < 20; i++) {
        setTimeout(() => {
          const firework = document.createElement('div');
          firework.className = 'firework';
          firework.style.left = Math.random() * 100 + '%';
          firework.style.top = Math.random() * 100 + '%';
          firework.style.backgroundColor = colors[Math.floor(Math.random() * colors.length)];
          
          fireworksContainer.appendChild(firework);
          
          // Ìè≠Ï£Ω Ï†úÍ±∞
          setTimeout(() => {
            if (firework.parentNode) {
              firework.parentNode.removeChild(firework);
            }
          }, 1500);
          
          // Î∞òÏßùÏù¥ Ìö®Í≥º Ï∂îÍ∞Ä
          for (let j = 0; j < 8; j++) {
            setTimeout(() => {
              const sparkle = document.createElement('div');
              sparkle.className = 'sparkle';
              sparkle.style.left = firework.style.left;
              sparkle.style.top = firework.style.top;
              sparkle.style.animationDelay = Math.random() * 0.5 + 's';
              
              fireworksContainer.appendChild(sparkle);
              
              setTimeout(() => {
                if (sparkle.parentNode) {
                  sparkle.parentNode.removeChild(sparkle);
                }
              }, 800);
            }, j * 100);
          }
        }, i * 200);
      }
    }
    
    // ÏãúÏûë
    init(DEFAULT_SOUNDS);
  </script>
</body>
</html>
