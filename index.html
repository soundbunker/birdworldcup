<!doctype html>
<html lang="ko">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>ìƒˆì†Œë¦¬ ì´ìƒí˜•ì›”ë“œì»µ (12ê°œ)</title>
  <style>
    :root {
      --bg: #0b0f14;
      --card: #121826;
      --muted: #94a3b8;
      --text: #e5e7eb;
      --accent: #60a5fa;
      --accent-2: #34d399;
      --danger: #f87171;
      --ring: rgba(96,165,250,.45);
      --radius: 16px;
      
      /* ë¼ìš´ë“œë³„ ë°°ê²½ìƒ‰ */
      --round1-bg: rgba(59, 130, 246, 0.15);
      --round2-bg: rgba(239, 68, 68, 0.15);
      --round3-bg: rgba(34, 197, 94, 0.15);
      --round4-bg: rgba(168, 85, 247, 0.15);
      --final-bg: rgba(251, 191, 36, 0.15);
    }
    * { box-sizing: border-box; }
    html, body { height: 100%; }
    body {
      margin: 0; font-family: ui-sans-serif, system-ui, -apple-system, "Segoe UI", Roboto, "Helvetica Neue", Arial, "Apple SD Gothic Neo", "Noto Sans KR", "Malgun Gothic", sans-serif;
      background: radial-gradient(1200px 800px at 20% -20%, #1f2937 0%, transparent 60%),
                  radial-gradient(1000px 700px at 120% 0%, #0f172a 0%, transparent 65%),
                  var(--bg);
      color: var(--text);
      display: flex; align-items: center; justify-content: center;
      padding: 12px;
      min-height: 100vh;
      overflow-x: hidden;
    }
    .app { width: 100%; max-width: 1100px; min-height: 100%; }
    header { display:flex; align-items:center; justify-content:space-between; gap: 8px; margin-bottom: 12px; flex-wrap: wrap; }
    h1 { margin: 0; font-size: clamp(16px, 4vw, 28px); font-weight: 800; letter-spacing: 0.2px; line-height: 1.2; }
    .toolbar { display:flex; flex-wrap: wrap; gap: 6px; }
    button, .btn {
      background: linear-gradient(180deg, #1f2937, #0b1220);
      color: var(--text); border: 1px solid #1f2a44; padding: 12px 16px; border-radius: 12px;
      cursor: pointer; font-weight: 600; transition: .2s ease; font-size: 14px;
      min-height: 44px; /* ëª¨ë°”ì¼ í„°ì¹˜ ì¹œí™”ì  */
      display: flex; align-items: center; justify-content: center;
      touch-action: manipulation; /* ëª¨ë°”ì¼ í„°ì¹˜ ìµœì í™” */
    }
    button:hover { border-color: var(--accent); box-shadow: 0 0 0 4px var(--ring); }
    .btn-secondary { background: #111827; }
    .btn-danger { border-color: #402227; background: #1a0f12; color: #fecaca; }

    .stage { background: rgba(17,24,39,.6); border: 1px solid #1f2a44; border-radius: var(--radius); padding: 16px; transition: background 0.5s ease; }
    .stage.round-1 { background: var(--round1-bg); border-color: rgba(59, 130, 246, 0.3); }
    .stage.round-2 { background: var(--round2-bg); border-color: rgba(239, 68, 68, 0.3); }
    .stage.round-3 { background: var(--round3-bg); border-color: rgba(34, 197, 94, 0.3); }
    .stage.round-4 { background: var(--round4-bg); border-color: rgba(168, 85, 247, 0.3); }
    .stage.final { background: var(--final-bg); border-color: rgba(251, 191, 36, 0.3); }
    .status { display:flex; align-items:center; justify-content:space-between; gap: 8px; margin-bottom: 12px; font-size: 13px; color: var(--muted); flex-wrap: wrap; }
    .status b { color: var(--text); }
    .round-title { font-size: clamp(20px, 5vw, 36px); font-weight: 900; text-align: center; margin-bottom: 16px; color: var(--text); text-shadow: 0 2px 4px rgba(0,0,0,0.5); line-height: 1.2; }

    .versus { display:grid; grid-template-columns: 1fr auto 1fr; gap: 8px; align-items: stretch; }
    .card { background: var(--card); border: 1px solid #1f2a44; border-radius: var(--radius); padding: 12px; display:flex; flex-direction:column; gap: 8px; position: relative; min-height: 240px; cursor: pointer; transition: transform 0.2s ease, box-shadow 0.2s ease; }
    .card:active { transform: scale(0.98); }
    .bird-image { width: 100%; height: 120px; object-fit: cover; border-radius: 8px; background: #1f2937; border: 1px solid #374151; }
    .image-placeholder { width: 100%; height: 120px; background: linear-gradient(135deg, #1f2937, #374151); border-radius: 8px; display: flex; align-items: center; justify-content: center; color: var(--muted); font-size: 20px; border: 1px solid #374151; }
    .card.winner { outline: 3px solid var(--accent-2); }
    .label { font-weight: 800; font-size: clamp(14px, 3vw, 18px); line-height: 1.2; text-align: center; }
    .sub { color: var(--muted); font-size: 11px; text-align: center; }

    .audio { display:flex; align-items:center; gap: 8px; }
    .audio button { padding: 10px 12px; min-height: 40px; }
    .progress { height: 6px; background:#111827; border-radius: 999px; overflow: hidden; border: 1px solid #1f2a44; }
    .bar { height: 100%; width: 0%; background: linear-gradient(90deg, var(--accent), #22d3ee); }

    .vs { display:flex; align-items:center; justify-content:center; font-weight:900; font-size: clamp(20px, 5vw, 28px); color:#cbd5e1; }

    .card-button { width: 100%; margin-top: 8px; padding: 12px; font-size: 14px; min-height: 44px; background: linear-gradient(180deg, var(--accent), #1e40af); border: 1px solid var(--accent); color: white; font-weight: 700; }
    .card-button:hover { background: linear-gradient(180deg, #3b82f6, var(--accent)); border-color: #3b82f6; }
    .card-button:active { transform: scale(0.98); }
    .next { width: 100%; margin-top: 12px; padding: 14px; font-size: 14px; min-height: 48px; }


    .footer { margin-top: 12px; color: var(--muted); font-size: 11px; display:flex; justify-content: space-between; gap: 8px; flex-wrap: wrap; }
    .footer code { background:#0b1220; padding:2px 6px; border-radius:6px; border:1px solid #1f2a44; }
    .copyright { margin-top: 20px; text-align: center; color: var(--muted); font-size: 11px; border-top: 1px solid #1f2a44; padding-top: 12px; }
    .copyright a { color: var(--accent); text-decoration: none; }
    .copyright a:hover { text-decoration: underline; }

    .hidden { display: none; }
    
    /* ì˜¬ë¦¼í”½ ë‹¨ìƒ ìŠ¤íƒ€ì¼ */
    .podium { display: none; flex-direction: column; align-items: center; gap: 20px; padding: 30px; position: relative; overflow: hidden; }
    .podium.show { display: flex; }
    .podium-title { font-size: clamp(28px, 5vw, 42px); font-weight: 900; color: var(--text); text-shadow: 0 2px 8px rgba(0,0,0,0.7); margin-bottom: 20px; }
    .podium-container { display: flex; align-items: end; gap: 15px; justify-content: center; flex-wrap: wrap; }
    .podium-place { display: flex; flex-direction: column; align-items: center; position: relative; opacity: 0; transform: translateY(50px); transition: all 0.8s ease; }
    .podium-place.show { opacity: 1; transform: translateY(0); }
    .podium-image { width: 120px; height: 120px; border-radius: 50%; object-fit: cover; border: 4px solid; margin-bottom: 10px; }
    .podium-base { display: flex; flex-direction: column; align-items: center; justify-content: center; border-radius: 8px; padding: 15px 20px; position: relative; }
    .podium-rank { font-size: 24px; font-weight: 900; margin-bottom: 5px; }
    .podium-name { font-size: 16px; font-weight: 600; text-align: center; }
    
    .first-place .podium-image { border-color: #ffd700; box-shadow: 0 0 20px rgba(255, 215, 0, 0.5); }
    .first-place .podium-base { background: linear-gradient(145deg, #ffd700, #ffed4a); color: #1a1a1a; height: 100px; }
    .first-place .podium-rank::before { content: 'ğŸ¥‡ '; }
    
    .second-place .podium-image { border-color: #c0c0c0; box-shadow: 0 0 15px rgba(192, 192, 192, 0.5); }
    .second-place .podium-base { background: linear-gradient(145deg, #c0c0c0, #e5e5e5); color: #1a1a1a; height: 80px; }
    .second-place .podium-rank::before { content: 'ğŸ¥ˆ '; }
    
    /* í­ì£½ íš¨ê³¼ */
    .fireworks { position: absolute; top: 0; left: 0; width: 100%; height: 100%; pointer-events: none; overflow: hidden; }
    .firework { position: absolute; width: 6px; height: 6px; border-radius: 50%; }
    
    @keyframes explode {
      0% {
        transform: scale(0) rotate(0deg);
        opacity: 1;
      }
      100% {
        transform: scale(15) rotate(180deg);
        opacity: 0;
      }
    }
    
    @keyframes sparkle {
      0%, 100% {
        transform: scale(0);
        opacity: 0;
      }
      50% {
        transform: scale(1);
        opacity: 1;
      }
    }
    
    .firework {
      animation: explode 1.5s ease-out forwards;
    }
    
    .sparkle {
      position: absolute;
      width: 4px;
      height: 4px;
      background: #ffd700;
      border-radius: 50%;
      animation: sparkle 0.8s ease-in-out infinite;
    }
    
    .third-place .podium-image { border-color: #cd7f32; box-shadow: 0 0 15px rgba(205, 127, 50, 0.5); }
    .third-place .podium-base { background: linear-gradient(145deg, #cd7f32, #daa520); color: #1a1a1a; height: 60px; }
    .third-place .podium-rank::before { content: 'ğŸ¥‰ '; }
    
    /* ëª¨ë°”ì¼ ìµœì í™” */
    @media (max-width: 768px) {
      body { padding: 8px; }
      .app { padding: 0; }
      header { flex-direction: column; align-items: stretch; gap: 12px; }
      .toolbar { justify-content: center; }
      .versus { grid-template-columns: 1fr; gap: 12px; }
      .vs { order: -1; font-size: 24px; padding: 8px 0; }
      .card { min-height: 200px; padding: 10px; }
      .bird-image, .image-placeholder { height: 100px; }
      .card-button { font-size: 15px; padding: 14px 12px; }
      .next { padding: 16px; font-size: 15px; }
      .stage { padding: 12px; }
      .round-title { margin-bottom: 12px; }
      .podium-container { flex-direction: column; align-items: center; gap: 20px; }
      .podium-place { margin-bottom: 0; }
      .podium-image { width: 100px; height: 100px; }
      .copyright { font-size: 10px; padding-top: 8px; }
    }
    
    @media (max-width: 480px) {
      .toolbar { flex-direction: column; }
      .toolbar button, .toolbar .btn { width: 100%; }
      .card { min-height: 180px; }
      .bird-image, .image-placeholder { height: 80px; font-size: 18px; }
      .label { font-size: 13px; }
      .sub { font-size: 10px; }
      .vs { font-size: 20px; }
      .card-button { font-size: 14px; padding: 12px 8px; }
      .podium-title { font-size: 20px; }
    }
  </style>
</head>
<body>
  <div class="app">
    <header>
      <h1>ğŸ•Šï¸ ìƒˆì†Œë¦¬ ì´ìƒí˜•ì›”ë“œì»µ</h1>
      <div class="toolbar">
        <label class="btn btn-secondary" title="ì˜¤ë””ì˜¤ì™€ ì´ë¯¸ì§€ íŒŒì¼ì„ ì„ íƒí•´ ë°”ë¡œ ì‹œì‘">
          íŒŒì¼ ë¶ˆëŸ¬ì˜¤ê¸°<input id="fileInput" type="file" accept="audio/*,image/*" multiple class="hidden" />
        </label>
        <button id="shuffleBtn" class="btn btn-secondary" title="í˜„ì¬ ë¼ìš´ë“œ ì°¸ê°€ì ì„ê¸°">ì…”í”Œ</button>
        <button id="restartBtn" class="btn btn-secondary" title="ì²˜ìŒë¶€í„° ë‹¤ì‹œ">ì²˜ìŒë¶€í„°</button>
        <button id="exportBtn" class="btn" title="ê²°ê³¼ë¥¼ JSONìœ¼ë¡œ ì €ì¥">ê²°ê³¼ ë‚´ë³´ë‚´ê¸°</button>
      </div>
    </header>

    <div class="stage">
      <div class="round-title" id="roundTitle">-</div>
      <div class="status">
        <div>ë§¤ì¹˜ <b id="matchIndex">0</b>/<b id="matchTotal">0</b></div>
        <div>ë‚¨ì€ ì°¸ê°€ì: <b id="remaining">0</b></div>
      </div>

      <div class="versus">
        <div class="card" id="leftCard">
          <div id="leftImageContainer" class="image-placeholder">ğŸ¦</div>
          <div class="label" id="leftLabel">-</div>
          <div class="sub" id="leftSub">ì´ ìƒˆì†Œë¦¬ë¥¼ ë“¤ì–´ë³´ì„¸ìš”</div>
          <div class="audio">
            <button id="leftPlay" aria-label="ì¬ìƒ/ì¼ì‹œì •ì§€">â–¶ï¸/â¸</button>
            <div class="progress" style="flex:1">
              <div class="bar" id="leftBar"></div>
            </div>
          </div>
          <button class="card-button" id="chooseLeft">ì´ ìƒˆë¥¼ ì„ íƒí•˜ê¸°</button>
        </div>
        <div class="vs">VS</div>
        <div class="card" id="rightCard">
          <div id="rightImageContainer" class="image-placeholder">ğŸ¦</div>
          <div class="label" id="rightLabel">-</div>
          <div class="sub" id="rightSub">ì´ ìƒˆì†Œë¦¬ë¥¼ ë“¤ì–´ë³´ì„¸ìš”</div>
          <div class="audio">
            <button id="rightPlay" aria-label="ì¬ìƒ/ì¼ì‹œì •ì§€">â–¶ï¸/â¸</button>
            <div class="progress" style="flex:1">
              <div class="bar" id="rightBar"></div>
            </div>
          </div>
          <button class="card-button" id="chooseRight">ì´ ìƒˆë¥¼ ì„ íƒí•˜ê¸°</button>
        </div>
      </div>

      <button id="nextBtn" class="next btn-secondary hidden">ë‹¤ìŒ ë§¤ì¹˜ (Enter)</button>

      <div class="footer">
        <div>ë‹¨ì¶•í‚¤: <code>L</code>/<code>R</code> ì„ íƒ, <code>Space</code> ì¬ìƒ/ì¼ì‹œì •ì§€</div>
        <div id="winnerBanner"></div>
      </div>
    </div>
    
    <!-- ì˜¬ë¦¼í”½ ë‹¨ìƒ ìŠ¤íƒ€ì¼ ìˆœìœ„ í‘œì‹œ -->
    <div class="podium" id="podium">
      <div class="podium-title">ğŸ† ìƒˆì†Œë¦¬ ì›”ë“œì»µ ê²°ê³¼ ğŸ†</div>
      <div class="fireworks" id="fireworks"></div>
      <div class="podium-container">
        <div class="podium-place first-place" id="firstPlaceElement">
          <div class="podium-image-container">
            <div class="image-placeholder" id="firstPlaceImage">ğŸ¦</div>
          </div>
          <div class="podium-base">
            <div class="podium-rank">1ë“±</div>
            <div class="podium-name" id="firstPlaceName">-</div>
          </div>
        </div>
        <div class="podium-place second-place" id="secondPlaceElement">
          <div class="podium-image-container">
            <div class="image-placeholder" id="secondPlaceImage">ğŸ¦</div>
          </div>
          <div class="podium-base">
            <div class="podium-rank">2ë“±</div>
            <div class="podium-name" id="secondPlaceName">-</div>
          </div>
        </div>
      </div>
      
      <div class="copyright">
        Â© 2024 TheSoundBunker inc. All rights reserved. | ë¬¸ì˜: <a href="mailto:play@soundb.kr">play@soundb.kr</a>
      </div>
    </div>

    <audio id="leftAudio"></audio>
    <audio id="rightAudio"></audio>
    <audio id="victoryAudio" preload="auto"></audio>
    
    <div class="copyright">
      Â© 2024 TheSoundBunker inc. All rights reserved. | ë¬¸ì˜: <a href="mailto:play@soundb.kr">play@soundb.kr</a>
    </div>
  </div>

  <script>
    // ======== ì„¤ì •(ìˆ˜ì • ê°€ëŠ¥) ========
    // 1) URL(ë˜ëŠ” íŒŒì¼) ì—†ì´ë„ ë¯¸ë¦¬ë³´ê¸° ë˜ë„ë¡ ë”ë¯¸ í•­ëª©ì„ ë„£ì–´ë‘¡ë‹ˆë‹¤.
    // ì‹¤ì œ ì‚¬ìš© ì‹œ ì•„ë˜ ë°°ì—´ì„ 12ê°œ í•­ëª©ìœ¼ë¡œ êµì²´í•˜ê±°ë‚˜, ìƒë‹¨ì˜ "íŒŒì¼ ë¶ˆëŸ¬ì˜¤ê¸°"ë¡œ ë¡œì»¬ íŒŒì¼ì„ íƒí•˜ì„¸ìš”.
    const DEFAULT_SOUNDS = [
      { name: "í°ë¶€ë¦¬ê¹Œë§ˆê·€", src: "sound/12_í°ë¶€ë¦¬ê¹Œë§ˆê·€.mp3", imageUrl: "images/12_í°ë¶€ë¦¬ê¹Œë§ˆê·€.jpg" },
      { name: "ë°•ìƒˆ", src: "sound/13_ë°•ìƒˆ.mp3", imageUrl: "images/13_ë°•ìƒˆ.jpg" },
      { name: "ê³¤ì¤„ë°•ì´", src: "sound/15_ê³¤ì¤„ë°•ì´.mp3", imageUrl: "images/15_ê³¤ì¤„ë°•ì´.JPG" },
      { name: "ì‡ ë°•ìƒˆ", src: "sound/16_ì‡ ë°•ìƒˆ.mp3", imageUrl: "images/16_ì‡ ë°•ìƒˆ.jpg" },
      { name: "êµ´ëšìƒˆ", src: "sound/21_êµ´ëšìƒˆ.mp3", imageUrl: "images/21_êµ´ëšìƒˆ.png" },
      { name: "ë˜ì§€ë¹ ê·€", src: "sound/22_ë˜ì§€ë¹ ê·€.mp3", imageUrl: "images/22_ë˜ì§€ë¹ ê·€.jpg" },
      { name: "ë”±ìƒˆ", src: "sound/25_ë”±ìƒˆ.mp3", imageUrl: "images/25_ë”±ìƒˆ.jpg" },
      { name: "ë…¸ë‘í• ë¯¸ìƒˆ", src: "sound/27_ë…¸ë‘í• ë¯¸ìƒˆ.mp3", imageUrl: "images/27_ë…¸ë‘í• ë¯¸ìƒˆ.jpg" },
      { name: "ë…¸ë‘í„±ë©§ìƒˆ", src: "sound/30_ë…¸ë‘í„±ë©§ìƒˆ.mp3", imageUrl: "images/30_ë…¸ë‘í„±ë©§ìƒˆ.jpg" },
      { name: "ê²€ì€ë“±ë»ê¾¸ê¸°", src: "sound/4_ê²€ì€ë“±ë»ê¾¸ê¸°.mp3", imageUrl: "images/4_ê²€ì€ë“±ë»ê¾¸ê¸°.png" },
      { name: "ë»ê¾¸ê¸°", src: "sound/5_ë»ê¾¸ê¸°.mp3", imageUrl: "images/5_ë»ê¾¸ê¸°.jpg" },
      { name: "ê¾€ê¼¬ë¦¬", src: "sound/9_ê¾€ê¼¬ë¦¬.mp3", imageUrl: "images/9_ê¾€ê¼¬ë¦¬.jpg" },
    ];

    // ======== ë¡œì§ ì‹œì‘ ========
    const leftAudio = document.getElementById('leftAudio');
    const rightAudio = document.getElementById('rightAudio');
    const leftPlay = document.getElementById('leftPlay');
    const rightPlay = document.getElementById('rightPlay');
    const leftBar = document.getElementById('leftBar');
    const rightBar = document.getElementById('rightBar');

    const leftLabel = document.getElementById('leftLabel');
    const rightLabel = document.getElementById('rightLabel');
    const leftCard = document.getElementById('leftCard');
    const rightCard = document.getElementById('rightCard');
    const leftImageContainer = document.getElementById('leftImageContainer');
    const rightImageContainer = document.getElementById('rightImageContainer');

    const roundNameEl = document.getElementById('roundName');
    const matchIndexEl = document.getElementById('matchIndex');
    const matchTotalEl = document.getElementById('matchTotal');
    const remainingEl = document.getElementById('remaining');
    const winnerBanner = document.getElementById('winnerBanner');
    const roundTitle = document.getElementById('roundTitle');
    const stage = document.querySelector('.stage');
    const podium = document.getElementById('podium');
    const firstPlaceImage = document.getElementById('firstPlaceImage');
    const secondPlaceImage = document.getElementById('secondPlaceImage');
    const firstPlaceName = document.getElementById('firstPlaceName');
    const secondPlaceName = document.getElementById('secondPlaceName');
    const firstPlaceElement = document.getElementById('firstPlaceElement');
    const secondPlaceElement = document.getElementById('secondPlaceElement');
    const fireworksContainer = document.getElementById('fireworks');
    const victoryAudio = document.getElementById('victoryAudio');

    const chooseLeftBtn = document.getElementById('chooseLeft');
    const chooseRightBtn = document.getElementById('chooseRight');
    const nextBtn = document.getElementById('nextBtn');
    const shuffleBtn = document.getElementById('shuffleBtn');
    const restartBtn = document.getElementById('restartBtn');
    const exportBtn = document.getElementById('exportBtn');
    const fileInput = document.getElementById('fileInput');

    let state = {
      participants: [],
      currentRound: [],
      nextRound: [],
      index: 0,
      left: null,
      right: null,
      roundNumber: 1,
      history: [], // ê° ë¼ìš´ë“œì˜ ë§¤ì¹˜ ê¸°ë¡
      rankings: [], // ìˆœìœ„ ê¸°ë¡ (3ë“±, 2ë“±, 1ë“± ìˆœ)
    };

    function shuffle(arr) {
      const a = [...arr];
      for (let i = a.length - 1; i > 0; i--) {
        const j = Math.floor(Math.random() * (i + 1));
        [a[i], a[j]] = [a[j], a[i]];
      }
      return a;
    }

    function roundLabel(n, size) {
      if (size === 1) return 'ê²°ìŠ¹';
      if (size === 2) return 'ê²°ìŠ¹';
      if (size === 4) return '4ê°•';
      if (size === 8) return '8ê°•';
      if (size === 16) return '16ê°•';
      return `ë¼ìš´ë“œ ${n}`;
    }

    function createPairs(list) {
      // í™€ìˆ˜ë©´ ë§ˆì§€ë§‰ í•˜ë‚˜ëŠ” ë¶€ì „ìŠ¹(byes)
      const pairs = [];
      for (let i = 0; i < list.length - 1; i += 2) {
        pairs.push([list[i], list[i + 1]]);
      }
      const bye = list.length % 2 === 1 ? list[list.length - 1] : null;
      return { pairs, bye };
    }

    function updateStatus() {
      const remaining = state.currentRound.length - state.index * 2;
      const totalMatches = Math.ceil(state.currentRound.length / 2);
      const roundName = roundLabel(state.roundNumber, state.currentRound.length);
      
      // ë¼ìš´ë“œ ì œëª© ì—…ë°ì´íŠ¸
      roundTitle.textContent = roundName;
      
      // ë¼ìš´ë“œë³„ ë°°ê²½ìƒ‰ ì ìš©
      stage.className = 'stage';
      if (state.currentRound.length <= 2) {
        stage.classList.add('final');
      } else if (state.currentRound.length <= 4) {
        stage.classList.add('round-4');
      } else if (state.currentRound.length <= 8) {
        stage.classList.add('round-3');
      } else if (state.currentRound.length <= 16) {
        stage.classList.add('round-2');
      } else {
        stage.classList.add('round-1');
      }
      
      matchIndexEl.textContent = Math.min(state.index + 1, totalMatches);
      matchTotalEl.textContent = totalMatches;
      remainingEl.textContent = state.currentRound.length;

    }

    function loadMatch() {
      const i = state.index * 2;
      state.left = state.currentRound[i] || null;
      state.right = state.currentRound[i + 1] || null;

      leftCard.classList.remove('winner');
      rightCard.classList.remove('winner');

      if (!state.left && !state.right) {
        // ë¼ìš´ë“œ ì¢…ë£Œ â†’ ë‹¤ìŒ ë¼ìš´ë“œë¡œ
        advanceRound();
        return;
      }

      if (state.left && !state.right) {
        // ë¶€ì „ìŠ¹ ì²˜ë¦¬
        state.nextRound.push(state.left);
        state.history[state.roundNumber - 1].push({ left: state.left.name, right: null, winner: state.left.name });
        state.index++;
        loadMatch();
        return;
      }

      leftLabel.textContent = state.left?.name ?? '-';
      rightLabel.textContent = state.right?.name ?? '-';

      leftAudio.src = state.left?.src || '';
      rightAudio.src = state.right?.src || '';
      leftAudio.pause(); rightAudio.pause();
      leftAudio.currentTime = 0; rightAudio.currentTime = 0;
      leftBar.style.width = '0%'; rightBar.style.width = '0%';

      // ìƒˆ ì´ë¯¸ì§€ ë¡œë“œ
      loadBirdImage(state.left, leftImageContainer);
      loadBirdImage(state.right, rightImageContainer);

      updateStatus();
      winnerBanner.textContent = '';
    }

    function advanceRound() {
      // ìš°ìŠ¹ìë§Œ ë‚¨ê²¨ ë‹¤ìŒ ë¼ìš´ë“œ êµ¬ì„±
      if (state.nextRound.length === 1) {
        // ìµœì¢… ìš°ìŠ¹ - ê²°ìŠ¹ íƒˆë½ìë¥¼ 2ë“±ìœ¼ë¡œ, ìš°ìŠ¹ìë¥¼ 1ë“±ìœ¼ë¡œ ê¸°ë¡
        const champion = state.nextRound[0];
        const runnerUp = state.currentRound.find(p => p !== champion);
        if (runnerUp) state.rankings.push(runnerUp); // 2ë“±
        state.rankings.push(champion); // 1ë“±
        
        showPodium();
        return;
      }
      state.currentRound = [...state.nextRound];
      state.nextRound = [];
      state.index = 0;
      state.roundNumber++;
      state.history.push([]);
      loadMatch();
    }
    
    function showPodium() {
      document.querySelector('.stage').style.display = 'none';
      podium.classList.add('show');
      
      // ìŠ¹ë¦¬ íš¨ê³¼ìŒ ì¬ìƒ
      playVictorySound();
      
      // 1ë“±ê³¼ 2ë“± ë°ì´í„° ì¤€ë¹„
      const rankings = state.rankings;
      const secondPlace = rankings[rankings.length - 2];
      const firstPlace = rankings[rankings.length - 1];
      
      // 1ë“± ë¨¼ì € í‘œì‹œ (1ì´ˆ í›„)
      setTimeout(() => {
        if (firstPlace) {
          firstPlaceName.textContent = firstPlace.name;
          loadPodiumImage(firstPlace, firstPlaceImage);
          firstPlaceElement.classList.add('show');
          createFireworks();
        }
      }, 1000);
      
      // 2ë“± ë‚˜ì¤‘ì— í‘œì‹œ (3ì´ˆ í›„)
      setTimeout(() => {
        if (secondPlace) {
          secondPlaceName.textContent = secondPlace.name;
          loadPodiumImage(secondPlace, secondPlaceImage);
          secondPlaceElement.classList.add('show');
        }
      }, 3000);
    }
    
    async function loadPodiumImage(bird, container) {
      try {
        // ë¡œì»¬ ì´ë¯¸ì§€ê°€ ìˆìœ¼ë©´ ìš°ì„  ì‚¬ìš©
        if (bird.imageUrl) {
          container.innerHTML = `<img src="${bird.imageUrl}" alt="${bird.name}" class="podium-image" onerror="this.parentElement.innerHTML='ğŸ¦'; this.parentElement.className='image-placeholder';">`;
          container.className = '';
          return;
        }

        const birdImageMap = {
          'í°ë¶€ë¦¬ê¹Œë§ˆê·€': '237',
          'ë°•ìƒˆ': '238', 
          'ê³¤ì¤„ë°•ì´': '239',
          'ì‡ ë°•ìƒˆ': '240',
          'êµ´ëšìƒˆ': '241',
          'ë˜ì§€ë¹ ê·€': '242',
          'ë”±ìƒˆ': '243',
          'ë…¸ë‘í• ë¯¸ìƒˆ': '244',
          'ë…¸ë‘í„±ë©§ìƒˆ': '245',
          'ê²€ì€ë“±ë»ê¾¸ê¸°': '246',
          'ë»ê¾¸ê¸°': '247',
          'ê¾€ê¼¬ë¦¬': '248'
        };
        
        const imageId = birdImageMap[bird.name] || '237';
        const imageUrl = `https://picsum.photos/150/150?random=${imageId}`;
        
        container.innerHTML = `<img src="${imageUrl}" alt="${bird.name}" class="podium-image" onerror="this.parentElement.innerHTML='ğŸ¦'; this.parentElement.className='image-placeholder';">`;
        container.className = '';
        
      } catch (error) {
        console.error('ì´ë¯¸ì§€ ë¡œë“œ ì‹¤íŒ¨:', error);
        container.innerHTML = 'ğŸ¦';
        container.className = 'image-placeholder';
      }
    }

    function choose(side) {
      if (!state.left || !state.right) return;
      const winner = side === 'left' ? state.left : state.right;
      const loser = side === 'left' ? state.right : state.left;
      state.nextRound.push(winner);
      state.history[state.roundNumber - 1].push({ left: state.left.name, right: state.right.name, winner: winner.name });
      if (side === 'left') { leftCard.classList.add('winner'); rightCard.classList.remove('winner'); }
      else { rightCard.classList.add('winner'); leftCard.classList.remove('winner'); }
      
      // ì„ íƒ í›„ ì ì‹œ ëŒ€ê¸°í•˜ê³  ìë™ìœ¼ë¡œ ë‹¤ìŒ ë§¤ì¹˜ë¡œ
      setTimeout(() => {
        nextMatch();
      }, 1000);
    }

    function nextMatch() {
      if (!state.left && !state.right) return;
      // ì„ íƒ ì—†ì´ ë„˜ê¸°ë©´ ë¶€ì „ìŠ¹ ì²˜ë¦¬(ì™¼ìª½)
      if (state.left && state.right && !leftCard.classList.contains('winner') && !rightCard.classList.contains('winner')) {
        choose('left');
      }
      state.index++;
      loadMatch();
    }

    function init(participants) {
      // 12ê°œ ë“± ì„ì˜ ì°¸ê°€ì ìˆ˜ë¥¼ ì§€ì›. ë¬´ì‘ìœ„ ì„ê¸°
      const list = shuffle(participants);
      state.participants = list;
      state.currentRound = [...list];
      state.nextRound = [];
      state.index = 0;
      state.roundNumber = 1;
      state.history = [[]];
      state.rankings = [];
      
      // UI ì´ˆê¸°í™”
      document.querySelector('.stage').style.display = 'block';
      podium.classList.remove('show');
      
      loadMatch();
    }

    // ì§„í–‰ ë°” ì—…ë°ì´íŠ¸
    leftAudio.addEventListener('timeupdate', () => {
      if (leftAudio.duration) leftBar.style.width = `${(leftAudio.currentTime / leftAudio.duration) * 100}%`;
    });
    rightAudio.addEventListener('timeupdate', () => {
      if (rightAudio.duration) rightBar.style.width = `${(rightAudio.currentTime / rightAudio.duration) * 100}%`;
    });

    function toggle(audio, other) {
      if (!audio.src) return;
      if (other && !other.paused) other.pause();
      if (audio.paused) audio.play(); else audio.pause();
    }

    leftPlay.addEventListener('click', () => toggle(leftAudio, rightAudio));
    rightPlay.addEventListener('click', () => toggle(rightAudio, leftAudio));

    chooseLeftBtn.addEventListener('click', () => choose('left'));
    chooseRightBtn.addEventListener('click', () => choose('right'));
    nextBtn.addEventListener('click', nextMatch);

    shuffleBtn.addEventListener('click', () => {
      state.currentRound = shuffle(state.currentRound);
      state.index = 0; state.nextRound = []; state.history[state.roundNumber - 1] = [];
      loadMatch();
    });

    restartBtn.addEventListener('click', () => init(state.participants.length ? state.participants : DEFAULT_SOUNDS));

    exportBtn.addEventListener('click', () => {
      const data = {
        rounds: state.history,
        finalists: state.nextRound.map(p => p.name),
      };
      const blob = new Blob([JSON.stringify(data, null, 2)], { type: 'application/json' });
      const url = URL.createObjectURL(blob);
      const a = document.createElement('a');
      a.href = url; a.download = 'birdcup_result.json'; a.click();
      URL.revokeObjectURL(url);
    });

    // íŒŒì¼ ë¶ˆëŸ¬ì˜¤ê¸°: ë¡œì»¬ ì˜¤ë””ì˜¤/ì´ë¯¸ì§€ íŒŒì¼ì„ ì„ íƒí•˜ë©´ ì°¸ê°€ì ìë™ êµ¬ì„±
    fileInput.addEventListener('change', async (e) => {
      const files = Array.from(e.target.files);
      const audioFiles = files.filter(f => f.type.startsWith('audio/'));
      const imageFiles = files.filter(f => f.type.startsWith('image/'));
      
      if (!audioFiles.length) return;
      
      // ì´ë¯¸ì§€ íŒŒì¼ë“¤ì„ ì´ë¦„ìœ¼ë¡œ ë§¤í•‘
      const imageMap = new Map();
      imageFiles.forEach(f => {
        const baseName = getBaseName(f.name);
        imageMap.set(baseName, URL.createObjectURL(f));
      });
      
      const list = audioFiles.map(f => {
        const baseName = getBaseName(f.name);
        const imageUrl = imageMap.get(baseName);
        return { 
          name: prettyName(f.name), 
          src: URL.createObjectURL(f),
          imageUrl: imageUrl
        };
      });
      
      init(list);
    });

    function prettyName(filename) {
      return filename.replace(/\.[^.]+$/, '') // í™•ì¥ì ì œê±°
                     .replace(/[\._-]+/g, ' ') // êµ¬ë¶„ì ê³µë°±í™”
                     .trim();
    }

    function getBaseName(filename) {
      // íŒŒì¼ ì´ë¦„ì—ì„œ ìˆ«ìë‚˜ íŠ¹ìˆ˜ë¬¸ìë¥¼ ì œê±°í•˜ê³  ê¸°ë³¸ ì´ë¦„ë§Œ ì¶”ì¶œ
      return filename.replace(/\.[^.]+$/, '') // í™•ì¥ì ì œê±°
                     .replace(/^\d+[._-]*/, '') // ì•ì˜ ìˆ«ì ì œê±°
                     .replace(/[._-]+/g, '') // êµ¬ë¶„ì ì œê±°
                     .toLowerCase()
                     .trim();
    }

    // í‚¤ë³´ë“œ ë‹¨ì¶•í‚¤
    window.addEventListener('keydown', (e) => {
      if (['INPUT', 'TEXTAREA'].includes(document.activeElement.tagName)) return;
      if (e.key.toLowerCase() === 'l') { e.preventDefault(); choose('left'); }
      if (e.key.toLowerCase() === 'r') { e.preventDefault(); choose('right'); }
      if (e.key === ' ') { e.preventDefault();
        // ìµœê·¼ì— ëˆŒë €ë˜ ìª½ í† ê¸€: ìš°ì„  ì˜¤ë¥¸ìª½ì´ ì¬ìƒ ì¤‘ì´ë©´ ì˜¤ë¥¸ìª½, ì•„ë‹ˆë©´ ì™¼ìª½
        if (!rightAudio.paused || (leftAudio.paused && rightAudio.paused)) toggle(leftAudio, rightAudio);
        else toggle(rightAudio, leftAudio);
      }
      if (e.key === 'Enter') { e.preventDefault(); nextMatch(); }
    });

    // ìƒˆ ì´ë¯¸ì§€ ë¡œë“œ í•¨ìˆ˜
    async function loadBirdImage(bird, container) {
      if (!bird) {
        container.innerHTML = 'ğŸ¦';
        container.className = 'image-placeholder';
        return;
      }

      try {
        // ë¡œì»¬ ì´ë¯¸ì§€ê°€ ìˆìœ¼ë©´ ìš°ì„  ì‚¬ìš©
        if (bird.imageUrl) {
          container.innerHTML = `<img src="${bird.imageUrl}" alt="${bird.name}" class="bird-image" onerror="this.parentElement.innerHTML='ğŸ¦'; this.parentElement.className='image-placeholder';">`;
          container.className = '';
          return;
        }

        // ê¸°ë³¸ ì´ë¯¸ì§€ (Picsum Photos - ë¬´ë£Œ, ì €ì‘ê¶Œ ì—†ìŒ)
        const birdImageMap = {
          'í°ë¶€ë¦¬ê¹Œë§ˆê·€': '237',
          'ë°•ìƒˆ': '238', 
          'ê³¤ì¤„ë°•ì´': '239',
          'ì‡ ë°•ìƒˆ': '240',
          'êµ´ëšìƒˆ': '241',
          'ë˜ì§€ë¹ ê·€': '242',
          'ë”±ìƒˆ': '243',
          'ë…¸ë‘í• ë¯¸ìƒˆ': '244',
          'ë…¸ë‘í„±ë©§ìƒˆ': '245',
          'ê²€ì€ë“±ë»ê¾¸ê¸°': '246',
          'ë»ê¾¸ê¸°': '247',
          'ê¾€ê¼¬ë¦¬': '248'
        };
        
        const imageId = birdImageMap[bird.name] || '237';
        const imageUrl = `https://picsum.photos/300/200?random=${imageId}`;
        
        container.innerHTML = `<img src="${imageUrl}" alt="${bird.name}" class="bird-image" onerror="this.parentElement.innerHTML='ğŸ¦'; this.parentElement.className='image-placeholder';">`;
        container.className = '';
      } catch (error) {
        console.error('ì´ë¯¸ì§€ ë¡œë“œ ì‹¤íŒ¨:', error);
        container.innerHTML = 'ğŸ¦';
        container.className = 'image-placeholder';
      }
    }

    // ìŠ¹ë¦¬ íš¨ê³¼ìŒ ìƒì„± ë° ì¬ìƒ
    function createVictorySound() {
      // Web Audio APIë¥¼ ì‚¬ìš©í•´ì„œ 'ë¹ ë°¤!' íš¨ê³¼ìŒ ìƒì„±
      const audioContext = new (window.AudioContext || window.webkitAudioContext)();
      const duration = 2.0;
      const sampleRate = audioContext.sampleRate;
      const buffer = audioContext.createBuffer(1, duration * sampleRate, sampleRate);
      const data = buffer.getChannelData(0);
      
      // íŒ¬íŒŒë ˆ ì‚¬ìš´ë“œ ìƒì„± (ë¹ ë°¤ ëŠë‚Œ)
      for (let i = 0; i < data.length; i++) {
        const t = i / sampleRate;
        let sound = 0;
        
        // ì²« ë²ˆì§¸ 'ë¹ ' (0.0-0.3ì´ˆ)
        if (t < 0.3) {
          const freq = 523 + Math.sin(t * 50) * 100; // C5 + vibrato
          sound += Math.sin(2 * Math.PI * freq * t) * Math.exp(-t * 8) * 0.5;
        }
        // ë‘ ë²ˆì§¸ 'ë°¤' (0.4-0.8ì´ˆ)
        else if (t > 0.4 && t < 0.8) {
          const t2 = t - 0.4;
          const freq = 659 + Math.sin(t2 * 60) * 120; // E5 + vibrato
          sound += Math.sin(2 * Math.PI * freq * t2) * Math.exp(-t2 * 6) * 0.6;
        }
        // ë¦¬ë²„ë¸Œ íš¨ê³¼
        if (t > 0.8) {
          const t3 = t - 0.8;
          sound += sound * 0.1 * Math.exp(-t3 * 3);
        }
        
        data[i] = Math.max(-1, Math.min(1, sound));
      }
      
      return buffer;
    }
    
    function playVictorySound() {
      try {
        const audioContext = new (window.AudioContext || window.webkitAudioContext)();
        const buffer = createVictorySound();
        const source = audioContext.createBufferSource();
        const gainNode = audioContext.createGain();
        
        source.buffer = buffer;
        gainNode.gain.value = 0.3; // ë³¼ë¥¨ ì¡°ì ˆ
        
        source.connect(gainNode);
        gainNode.connect(audioContext.destination);
        
        source.start();
      } catch (error) {
        console.log('ì˜¤ë””ì˜¤ ì¬ìƒ ì‹¤íŒ¨:', error);
        // í´ë°±: ê°„ë‹¨í•œ ë¹„í”„ìŒ
        if (navigator.vibrate) {
          navigator.vibrate([200, 100, 200, 100, 400]);
        }
      }
    }
    
    // í­ì£½ íš¨ê³¼ ìƒì„±
    function createFireworks() {
      const colors = ['#ffd700', '#ff6b6b', '#4ecdc4', '#45b7d1', '#96ceb4', '#ffeaa7'];
      
      for (let i = 0; i < 20; i++) {
        setTimeout(() => {
          const firework = document.createElement('div');
          firework.className = 'firework';
          firework.style.left = Math.random() * 100 + '%';
          firework.style.top = Math.random() * 100 + '%';
          firework.style.backgroundColor = colors[Math.floor(Math.random() * colors.length)];
          
          fireworksContainer.appendChild(firework);
          
          // í­ì£½ ì œê±°
          setTimeout(() => {
            if (firework.parentNode) {
              firework.parentNode.removeChild(firework);
            }
          }, 1500);
          
          // ë°˜ì§ì´ íš¨ê³¼ ì¶”ê°€
          for (let j = 0; j < 8; j++) {
            setTimeout(() => {
              const sparkle = document.createElement('div');
              sparkle.className = 'sparkle';
              sparkle.style.left = firework.style.left;
              sparkle.style.top = firework.style.top;
              sparkle.style.animationDelay = Math.random() * 0.5 + 's';
              
              fireworksContainer.appendChild(sparkle);
              
              setTimeout(() => {
                if (sparkle.parentNode) {
                  sparkle.parentNode.removeChild(sparkle);
                }
              }, 800);
            }, j * 100);
          }
        }, i * 200);
      }
    }
    
    // ì‹œì‘
    init(DEFAULT_SOUNDS);
  </script>
</body>
</html>
