<!doctype html>
<html lang="ko">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>ìƒˆì†Œë¦¬ ì´ìƒí˜•ì›”ë“œì»µ (12ê°œ)</title>
  <style>
    :root {
      --bg: #0b0f14;
      --card: #121826;
      --muted: #94a3b8;
      --text: #e5e7eb;
      --accent: #60a5fa;
      --accent-2: #34d399;
      --danger: #f87171;
      --ring: rgba(96,165,250,.45);
      --radius: 16px;
    }
    * { box-sizing: border-box; }
    html, body { height: 100%; }
    body {
      margin: 0; font-family: ui-sans-serif, system-ui, -apple-system, "Segoe UI", Roboto, "Helvetica Neue", Arial, "Apple SD Gothic Neo", "Noto Sans KR", "Malgun Gothic", sans-serif;
      background: radial-gradient(1200px 800px at 20% -20%, #1f2937 0%, transparent 60%),
                  radial-gradient(1000px 700px at 120% 0%, #0f172a 0%, transparent 65%),
                  var(--bg);
      color: var(--text);
      display: flex; align-items: center; justify-content: center;
      padding: 24px;
    }
    .app { width: 100%; max-width: 1100px; }
    header { display:flex; align-items:center; justify-content:space-between; gap: 12px; margin-bottom: 14px; }
    h1 { margin: 0; font-size: clamp(18px, 2.5vw, 28px); font-weight: 800; letter-spacing: 0.2px; }
    .toolbar { display:flex; flex-wrap: wrap; gap: 8px; }
    button, .btn {
      background: linear-gradient(180deg, #1f2937, #0b1220);
      color: var(--text); border: 1px solid #1f2a44; padding: 10px 14px; border-radius: 12px;
      cursor: pointer; font-weight: 600; transition: .2s ease; font-size: 14px;
    }
    button:hover { border-color: var(--accent); box-shadow: 0 0 0 4px var(--ring); }
    .btn-secondary { background: #111827; }
    .btn-danger { border-color: #402227; background: #1a0f12; color: #fecaca; }

    .stage { background: rgba(17,24,39,.6); border: 1px solid #1f2a44; border-radius: var(--radius); padding: 18px; }
    .status { display:flex; align-items:center; justify-content:space-between; gap: 8px; margin-bottom: 14px; font-size: 14px; color: var(--muted); }
    .status b { color: var(--text); }

    .versus { display:grid; grid-template-columns: 1fr auto 1fr; gap: 12px; align-items: stretch; }
    .card { background: var(--card); border: 1px solid #1f2a44; border-radius: var(--radius); padding: 16px; display:flex; flex-direction:column; gap: 12px; position: relative; min-height: 280px; }
    .bird-image { width: 100%; height: 150px; object-fit: cover; border-radius: 8px; background: #1f2937; border: 1px solid #374151; }
    .image-placeholder { width: 100%; height: 150px; background: linear-gradient(135deg, #1f2937, #374151); border-radius: 8px; display: flex; align-items: center; justify-content: center; color: var(--muted); font-size: 24px; border: 1px solid #374151; }
    .card.winner { outline: 3px solid var(--accent-2); }
    .label { font-weight: 800; font-size: clamp(16px, 2vw, 20px); line-height: 1.2; }
    .sub { color: var(--muted); font-size: 12px; }

    .audio { display:flex; align-items:center; gap: 10px; }
    .audio button { padding: 8px 12px; }
    .progress { height: 6px; background:#111827; border-radius: 999px; overflow: hidden; border: 1px solid #1f2a44; }
    .bar { height: 100%; width: 0%; background: linear-gradient(90deg, var(--accent), #22d3ee); }

    .vs { display:flex; align-items:center; justify-content:center; font-weight:900; font-size: 28px; color:#cbd5e1; }

    .actions { display:grid; grid-template-columns: 1fr 1fr; gap: 10px; margin-top: 4px; }
    .actions button { font-size: 16px; padding: 12px; }
    .next { width: 100%; margin-top: 12px; padding: 12px; font-size: 16px; }

    .bracket { margin-top: 16px; display:flex; gap: 6px; flex-wrap: wrap; }
    .chip { background:#111827; border:1px solid #1f2a44; border-radius: 999px; padding: 6px 10px; font-size: 12px; color:#cbd5e1; }

    .footer { margin-top: 12px; color: var(--muted); font-size: 12px; display:flex; justify-content: space-between; gap: 8px; }
    .footer code { background:#0b1220; padding:2px 6px; border-radius:6px; border:1px solid #1f2a44; }

    .hidden { display: none; }
    @media (max-width: 800px) {
      .versus { grid-template-columns: 1fr; }
      .vs { order: -1; }
    }
  </style>
</head>
<body>
  <div class="app">
    <header>
      <h1>ğŸ•Šï¸ ìƒˆì†Œë¦¬ ì´ìƒí˜•ì›”ë“œì»µ</h1>
      <div class="toolbar">
        <label class="btn btn-secondary" title="ì˜¤ë””ì˜¤ íŒŒì¼ 12ê°œë¥¼ ì„ íƒí•´ ë°”ë¡œ ì‹œì‘">
          íŒŒì¼ ë¶ˆëŸ¬ì˜¤ê¸°<input id="fileInput" type="file" accept="audio/*" multiple class="hidden" />
        </label>
        <button id="shuffleBtn" class="btn btn-secondary" title="í˜„ì¬ ë¼ìš´ë“œ ì°¸ê°€ì ì„ê¸°">ì…”í”Œ</button>
        <button id="restartBtn" class="btn btn-secondary" title="ì²˜ìŒë¶€í„° ë‹¤ì‹œ">ì²˜ìŒë¶€í„°</button>
        <button id="exportBtn" class="btn" title="ê²°ê³¼ë¥¼ JSONìœ¼ë¡œ ì €ì¥">ê²°ê³¼ ë‚´ë³´ë‚´ê¸°</button>
      </div>
    </header>

    <div class="stage">
      <div class="status">
        <div>ë¼ìš´ë“œ: <b id="roundName">-</b> Â· ë§¤ì¹˜ <b id="matchIndex">0</b>/<b id="matchTotal">0</b></div>
        <div>ë‚¨ì€ ì°¸ê°€ì: <b id="remaining">0</b></div>
      </div>

      <div class="versus">
        <div class="card" id="leftCard">
          <div id="leftImageContainer" class="image-placeholder">ğŸ¦</div>
          <div class="label" id="leftLabel">-</div>
          <div class="sub" id="leftSub">L í‚¤ë¡œ ì„ íƒ</div>
          <div class="audio">
            <button id="leftPlay" aria-label="ì™¼ìª½ ì¬ìƒ/ì¼ì‹œì •ì§€">â–¶ï¸/â¸</button>
            <div class="progress" style="flex:1">
              <div class="bar" id="leftBar"></div>
            </div>
          </div>
        </div>
        <div class="vs">VS</div>
        <div class="card" id="rightCard">
          <div id="rightImageContainer" class="image-placeholder">ğŸ¦</div>
          <div class="label" id="rightLabel">-</div>
          <div class="sub" id="rightSub">R í‚¤ë¡œ ì„ íƒ</div>
          <div class="audio">
            <button id="rightPlay" aria-label="ì˜¤ë¥¸ìª½ ì¬ìƒ/ì¼ì‹œì •ì§€">â–¶ï¸/â¸</button>
            <div class="progress" style="flex:1">
              <div class="bar" id="rightBar"></div>
            </div>
          </div>
        </div>
      </div>

      <div class="actions">
        <button id="chooseLeft" class="btn">â¬… ì™¼ìª½ ì„ íƒ (L)</button>
        <button id="chooseRight" class="btn">ì˜¤ë¥¸ìª½ ì„ íƒ (R) â¡</button>
      </div>
      <button id="nextBtn" class="next btn-secondary">ë‹¤ìŒ ë§¤ì¹˜ (Enter)</button>

      <div class="bracket" id="bracket"></div>

      <div class="footer">
        <div>ë‹¨ì¶•í‚¤: <code>L</code>/<code>R</code> ì„ íƒ, <code>Space</code> ì¬ìƒ/ì¼ì‹œì •ì§€, <code>Enter</code> ë‹¤ìŒ</div>
        <div id="winnerBanner"></div>
      </div>
    </div>

    <audio id="leftAudio"></audio>
    <audio id="rightAudio"></audio>
  </div>

  <script>
    // ======== ì„¤ì •(ìˆ˜ì • ê°€ëŠ¥) ========
    // 1) URL(ë˜ëŠ” íŒŒì¼) ì—†ì´ë„ ë¯¸ë¦¬ë³´ê¸° ë˜ë„ë¡ ë”ë¯¸ í•­ëª©ì„ ë„£ì–´ë‘¡ë‹ˆë‹¤.
    // ì‹¤ì œ ì‚¬ìš© ì‹œ ì•„ë˜ ë°°ì—´ì„ 12ê°œ í•­ëª©ìœ¼ë¡œ êµì²´í•˜ê±°ë‚˜, ìƒë‹¨ì˜ "íŒŒì¼ ë¶ˆëŸ¬ì˜¤ê¸°"ë¡œ ë¡œì»¬ íŒŒì¼ì„ íƒí•˜ì„¸ìš”.
    const DEFAULT_SOUNDS = [
      { name: "í°ë¶€ë¦¬ê¹Œë§ˆê·€", src: "sound/12_í°ë¶€ë¦¬ê¹Œë§ˆê·€.mp3", searchTerm: "crow" },
      { name: "ë°•ìƒˆ", src: "sound/13_ë°•ìƒˆ.mp3", searchTerm: "tit bird" },
      { name: "ê³¤ì¤„ë°•ì´", src: "sound/15_ê³¤ì¤„ë°•ì´.mp3", searchTerm: "marsh tit" },
      { name: "ì‡ ë°•ìƒˆ", src: "sound/16_ì‡ ë°•ìƒˆ.mp3", searchTerm: "coal tit" },
      { name: "êµ´ëšìƒˆ", src: "sound/21_êµ´ëšìƒˆ.mp3", searchTerm: "wren" },
      { name: "ë˜ì§€ë¹ ê·€", src: "sound/22_ë˜ì§€ë¹ ê·€.mp3", searchTerm: "thrush" },
      { name: "ë”±ìƒˆ", src: "sound/25_ë”±ìƒˆ.mp3", searchTerm: "robin" },
      { name: "ë…¸ë‘í• ë¯¸ìƒˆ", src: "sound/27_ë…¸ë‘í• ë¯¸ìƒˆ.mp3", searchTerm: "wagtail" },
      { name: "ë…¸ë‘í„±ë©§ìƒˆ", src: "sound/30_ë…¸ë‘í„±ë©§ìƒˆ.mp3", searchTerm: "bunting" },
      { name: "ê²€ì€ë“±ë»ê¾¸ê¸°", src: "sound/4_ê²€ì€ë“±ë»ê¾¸ê¸°.mp3", searchTerm: "cuckoo" },
      { name: "ë»ê¾¸ê¸°", src: "sound/5_ë»ê¾¸ê¸°.mp3", searchTerm: "cuckoo" },
      { name: "ê¾€ê¼¬ë¦¬", src: "sound/9_ê¾€ê¼¬ë¦¬.mp3", searchTerm: "oriole" },
    ];

    // ======== ë¡œì§ ì‹œì‘ ========
    const leftAudio = document.getElementById('leftAudio');
    const rightAudio = document.getElementById('rightAudio');
    const leftPlay = document.getElementById('leftPlay');
    const rightPlay = document.getElementById('rightPlay');
    const leftBar = document.getElementById('leftBar');
    const rightBar = document.getElementById('rightBar');

    const leftLabel = document.getElementById('leftLabel');
    const rightLabel = document.getElementById('rightLabel');
    const leftCard = document.getElementById('leftCard');
    const rightCard = document.getElementById('rightCard');
    const leftImageContainer = document.getElementById('leftImageContainer');
    const rightImageContainer = document.getElementById('rightImageContainer');

    const roundNameEl = document.getElementById('roundName');
    const matchIndexEl = document.getElementById('matchIndex');
    const matchTotalEl = document.getElementById('matchTotal');
    const remainingEl = document.getElementById('remaining');
    const bracketEl = document.getElementById('bracket');
    const winnerBanner = document.getElementById('winnerBanner');

    const chooseLeftBtn = document.getElementById('chooseLeft');
    const chooseRightBtn = document.getElementById('chooseRight');
    const nextBtn = document.getElementById('nextBtn');
    const shuffleBtn = document.getElementById('shuffleBtn');
    const restartBtn = document.getElementById('restartBtn');
    const exportBtn = document.getElementById('exportBtn');
    const fileInput = document.getElementById('fileInput');

    let state = {
      participants: [],
      currentRound: [],
      nextRound: [],
      index: 0,
      left: null,
      right: null,
      roundNumber: 1,
      history: [], // ê° ë¼ìš´ë“œì˜ ë§¤ì¹˜ ê¸°ë¡
    };

    function shuffle(arr) {
      const a = [...arr];
      for (let i = a.length - 1; i > 0; i--) {
        const j = Math.floor(Math.random() * (i + 1));
        [a[i], a[j]] = [a[j], a[i]];
      }
      return a;
    }

    function roundLabel(n, size) {
      if (size === 1) return 'ê²°ìŠ¹';
      if (size === 2) return 'ê²°ìŠ¹';
      if (size === 4) return '4ê°•';
      if (size === 8) return '8ê°•';
      if (size === 16) return '16ê°•';
      return `ë¼ìš´ë“œ ${n}`;
    }

    function createPairs(list) {
      // í™€ìˆ˜ë©´ ë§ˆì§€ë§‰ í•˜ë‚˜ëŠ” ë¶€ì „ìŠ¹(byes)
      const pairs = [];
      for (let i = 0; i < list.length - 1; i += 2) {
        pairs.push([list[i], list[i + 1]]);
      }
      const bye = list.length % 2 === 1 ? list[list.length - 1] : null;
      return { pairs, bye };
    }

    function updateStatus() {
      const remaining = state.currentRound.length - state.index * 2;
      const totalMatches = Math.ceil(state.currentRound.length / 2);
      roundNameEl.textContent = roundLabel(state.roundNumber, state.currentRound.length);
      matchIndexEl.textContent = Math.min(state.index + 1, totalMatches);
      matchTotalEl.textContent = totalMatches;
      remainingEl.textContent = state.currentRound.length;

      bracketEl.innerHTML = '';
      state.currentRound.forEach((p, i) => {
        const div = document.createElement('div');
        div.className = 'chip';
        div.textContent = `${i + 1}. ${p.name}`;
        bracketEl.appendChild(div);
      });
    }

    function loadMatch() {
      const i = state.index * 2;
      state.left = state.currentRound[i] || null;
      state.right = state.currentRound[i + 1] || null;

      leftCard.classList.remove('winner');
      rightCard.classList.remove('winner');

      if (!state.left && !state.right) {
        // ë¼ìš´ë“œ ì¢…ë£Œ â†’ ë‹¤ìŒ ë¼ìš´ë“œë¡œ
        advanceRound();
        return;
      }

      if (state.left && !state.right) {
        // ë¶€ì „ìŠ¹ ì²˜ë¦¬
        state.nextRound.push(state.left);
        state.history[state.roundNumber - 1].push({ left: state.left.name, right: null, winner: state.left.name });
        state.index++;
        loadMatch();
        return;
      }

      leftLabel.textContent = state.left?.name ?? '-';
      rightLabel.textContent = state.right?.name ?? '-';

      leftAudio.src = state.left?.src || '';
      rightAudio.src = state.right?.src || '';
      leftAudio.pause(); rightAudio.pause();
      leftAudio.currentTime = 0; rightAudio.currentTime = 0;
      leftBar.style.width = '0%'; rightBar.style.width = '0%';

      // ìƒˆ ì´ë¯¸ì§€ ë¡œë“œ
      loadBirdImage(state.left, leftImageContainer);
      loadBirdImage(state.right, rightImageContainer);

      updateStatus();
      winnerBanner.textContent = '';
    }

    function advanceRound() {
      // ìš°ìŠ¹ìë§Œ ë‚¨ê²¨ ë‹¤ìŒ ë¼ìš´ë“œ êµ¬ì„±
      if (state.nextRound.length === 1) {
        // ìµœì¢… ìš°ìŠ¹
        const champion = state.nextRound[0];
        winnerBanner.innerHTML = `ğŸ† ìµœì¢… ìš°ìŠ¹: <b>${champion.name}</b>`;
        state.currentRound = [champion];
        state.index = 0;
        updateStatus();
        return;
      }
      state.currentRound = [...state.nextRound];
      state.nextRound = [];
      state.index = 0;
      state.roundNumber++;
      state.history.push([]);
      loadMatch();
    }

    function choose(side) {
      if (!state.left || !state.right) return;
      const winner = side === 'left' ? state.left : state.right;
      const loser = side === 'left' ? state.right : state.left;
      state.nextRound.push(winner);
      state.history[state.roundNumber - 1].push({ left: state.left.name, right: state.right.name, winner: winner.name });
      if (side === 'left') { leftCard.classList.add('winner'); rightCard.classList.remove('winner'); }
      else { rightCard.classList.add('winner'); leftCard.classList.remove('winner'); }
    }

    function nextMatch() {
      if (!state.left && !state.right) return;
      // ì„ íƒ ì—†ì´ ë„˜ê¸°ë©´ ë¶€ì „ìŠ¹ ì²˜ë¦¬(ì™¼ìª½)
      if (state.left && state.right && !leftCard.classList.contains('winner') && !rightCard.classList.contains('winner')) {
        choose('left');
      }
      state.index++;
      loadMatch();
    }

    function init(participants) {
      // 12ê°œ ë“± ì„ì˜ ì°¸ê°€ì ìˆ˜ë¥¼ ì§€ì›. ë¬´ì‘ìœ„ ì„ê¸°
      const list = shuffle(participants);
      state.participants = list;
      state.currentRound = [...list];
      state.nextRound = [];
      state.index = 0;
      state.roundNumber = 1;
      state.history = [[]];
      loadMatch();
    }

    // ì§„í–‰ ë°” ì—…ë°ì´íŠ¸
    leftAudio.addEventListener('timeupdate', () => {
      if (leftAudio.duration) leftBar.style.width = `${(leftAudio.currentTime / leftAudio.duration) * 100}%`;
    });
    rightAudio.addEventListener('timeupdate', () => {
      if (rightAudio.duration) rightBar.style.width = `${(rightAudio.currentTime / rightAudio.duration) * 100}%`;
    });

    function toggle(audio, other) {
      if (!audio.src) return;
      if (other && !other.paused) other.pause();
      if (audio.paused) audio.play(); else audio.pause();
    }

    leftPlay.addEventListener('click', () => toggle(leftAudio, rightAudio));
    rightPlay.addEventListener('click', () => toggle(rightAudio, leftAudio));

    chooseLeftBtn.addEventListener('click', () => choose('left'));
    chooseRightBtn.addEventListener('click', () => choose('right'));
    nextBtn.addEventListener('click', nextMatch);

    shuffleBtn.addEventListener('click', () => {
      state.currentRound = shuffle(state.currentRound);
      state.index = 0; state.nextRound = []; state.history[state.roundNumber - 1] = [];
      loadMatch();
    });

    restartBtn.addEventListener('click', () => init(state.participants.length ? state.participants : DEFAULT_SOUNDS));

    exportBtn.addEventListener('click', () => {
      const data = {
        rounds: state.history,
        finalists: state.nextRound.map(p => p.name),
      };
      const blob = new Blob([JSON.stringify(data, null, 2)], { type: 'application/json' });
      const url = URL.createObjectURL(blob);
      const a = document.createElement('a');
      a.href = url; a.download = 'birdcup_result.json'; a.click();
      URL.revokeObjectURL(url);
    });

    // íŒŒì¼ ë¶ˆëŸ¬ì˜¤ê¸°: ë¡œì»¬ íŒŒì¼ì„ 12ê°œ ì„ íƒí•˜ë©´ ì°¸ê°€ì ìë™ êµ¬ì„±
    fileInput.addEventListener('change', async (e) => {
      const files = Array.from(e.target.files).filter(f => f.type.startsWith('audio/'));
      if (!files.length) return;
      const list = files.map(f => ({ name: prettyName(f.name), src: URL.createObjectURL(f) }));
      init(list);
    });

    function prettyName(filename) {
      return filename.replace(/\.[^.]+$/, '') // í™•ì¥ì ì œê±°
                     .replace(/[\._-]+/g, ' ') // êµ¬ë¶„ì ê³µë°±í™”
                     .trim();
    }

    // í‚¤ë³´ë“œ ë‹¨ì¶•í‚¤
    window.addEventListener('keydown', (e) => {
      if (['INPUT', 'TEXTAREA'].includes(document.activeElement.tagName)) return;
      if (e.key.toLowerCase() === 'l') { e.preventDefault(); choose('left'); }
      if (e.key.toLowerCase() === 'r') { e.preventDefault(); choose('right'); }
      if (e.key === ' ') { e.preventDefault();
        // ìµœê·¼ì— ëˆŒë €ë˜ ìª½ í† ê¸€: ìš°ì„  ì˜¤ë¥¸ìª½ì´ ì¬ìƒ ì¤‘ì´ë©´ ì˜¤ë¥¸ìª½, ì•„ë‹ˆë©´ ì™¼ìª½
        if (!rightAudio.paused || (leftAudio.paused && rightAudio.paused)) toggle(leftAudio, rightAudio);
        else toggle(rightAudio, leftAudio);
      }
      if (e.key === 'Enter') { e.preventDefault(); nextMatch(); }
    });

    // ìƒˆ ì´ë¯¸ì§€ ë¡œë“œ í•¨ìˆ˜ (Unsplash API ì‚¬ìš©)
    async function loadBirdImage(bird, container) {
      if (!bird) {
        container.innerHTML = 'ğŸ¦';
        container.className = 'image-placeholder';
        return;
      }

      try {
        // Unsplashì—ì„œ ìƒˆ ì´ë¯¸ì§€ ê²€ìƒ‰ (ë¬´ë£Œ, ì €ì‘ê¶Œ ì—†ìŒ)
        const response = await fetch(`https://api.unsplash.com/search/photos?query=${encodeURIComponent(bird.searchTerm)}&per_page=1&client_id=zlALDHYOuXIZiAaOKhrzB0Qp5-gNFwJTKRywbB1JFO0`);
        const data = await response.json();
        
        if (data.results && data.results.length > 0) {
          const imageUrl = data.results[0].urls.small;
          container.innerHTML = `<img src="${imageUrl}" alt="${bird.name}" class="bird-image" onerror="this.parentElement.innerHTML='ğŸ¦'; this.parentElement.className='image-placeholder';">`;
          container.className = '';
        } else {
          // ì´ë¯¸ì§€ë¥¼ ì°¾ì„ ìˆ˜ ì—†ëŠ” ê²½ìš° ì¼ë°˜ ìƒˆ ì´ë¯¸ì§€ ì‚¬ìš©
          const fallbackResponse = await fetch(`https://api.unsplash.com/search/photos?query=bird&per_page=1&client_id=zlALDHYOuXIZiAaOKhrzB0Qp5-gNFwJTKRywbB1JFO0`);
          const fallbackData = await fallbackResponse.json();
          if (fallbackData.results && fallbackData.results.length > 0) {
            const imageUrl = fallbackData.results[0].urls.small;
            container.innerHTML = `<img src="${imageUrl}" alt="${bird.name}" class="bird-image" onerror="this.parentElement.innerHTML='ğŸ¦'; this.parentElement.className='image-placeholder';">`;
            container.className = '';
          } else {
            container.innerHTML = 'ğŸ¦';
            container.className = 'image-placeholder';
          }
        }
      } catch (error) {
        console.error('ì´ë¯¸ì§€ ë¡œë“œ ì‹¤íŒ¨:', error);
        container.innerHTML = 'ğŸ¦';
        container.className = 'image-placeholder';
      }
    }

    // ì‹œì‘
    init(DEFAULT_SOUNDS);
  </script>
</body>
</html>
